<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>PyMiniRacer v0.11.1 - Disparate Treasures</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="PyMiniRacer v0.11.1"><meta property="og:description" content="In this last blog post, I discussed my
revival of PyMiniRacer, a neat
project created by Sqreen to embed the V8
JavaScript into Python. As of that post (v0.8.0), I had done a light
reorganization of the C++ side of PyMiniRacer, but nothing big there yet. Here
we talk about some extensions to PyMiniRacer, rolling up the changes up to
v0.11.1: JS Object and Array manipulation, directly calling JS functions
from Python, async support, and a discussion of the C++ changes needed to make
all that work."><meta property="og:type" content="article"><meta property="og:url" content="https://bpcreech.com/post/mini-racer-v0.11.1/"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-04-09T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PyMiniRacer v0.11.1"><meta name=twitter:description content="In this last blog post, I discussed my
revival of PyMiniRacer, a neat
project created by Sqreen to embed the V8
JavaScript into Python. As of that post (v0.8.0), I had done a light
reorganization of the C++ side of PyMiniRacer, but nothing big there yet. Here
we talk about some extensions to PyMiniRacer, rolling up the changes up to
v0.11.1: JS Object and Array manipulation, directly calling JS functions
from Python, async support, and a discussion of the C++ changes needed to make
all that work."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title="Disparate Treasures" rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/squirrel.png></div><div class="logo__item logo__text"><div class=logo__title>Disparate Treasures</div><div class=logo__tagline>Ben Creech's arbitrary stuff</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>PyMiniRacer v0.11.1</h1><p class=post__lead>Poke objects! Call functions! Await promises!</p></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#new-feature-rundown>New feature rundown</a><ul><li><a href=#manipulating-objects-and-arrays>Manipulating objects and arrays</a></li><li><a href=#direct-function-calls>Direct function calls</a></li><li><a href=#async-and-timeouts>Async and timeouts</a></li></ul></li><li><a href=#changes-to-the-pyminiracer-c-backend>Changes to the PyMiniRacer C++ backend</a><ul><li><a href=#clang-tidy><code>clang-tidy</code></a></li><li><a href=#inverting-pyminiracers-threading-model>Inverting PyMiniRacer&rsquo;s threading model</a></li><li><a href=#relieving-python-of-the-duty-of-managing-c-memory>Relieving Python of the duty of managing C++ memory</a></li></ul></li><li><a href=#contribute>Contribute!</a></li></ul></nav></div></div><div class="content post__content clearfix"><p>In <a href=https://bpcreech.com/post/mini-racer/>this last blog post</a>, I discussed my
revival of <a href=https://github.com/bpcreech/PyMiniRacer>PyMiniRacer</a>, a neat
project created by <a href=https://github.com/sqreen>Sqreen</a> to embed the V8
JavaScript into Python. As of that post (<code>v0.8.0</code>), I had done a light
reorganization of the C++ side of PyMiniRacer, but nothing big there yet. Here
we talk about some extensions to PyMiniRacer, rolling up the changes up to
<code>v0.11.1</code>: JS <code>Object</code> and <code>Array</code> manipulation, directly calling JS functions
from Python, <code>async</code> support, and a discussion of the C++ changes needed to make
all that work.</p><p>Some new PyMiniRacer features:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> py_mini_racer <span style=color:#f92672>import</span> MiniRacer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mr <span style=color:#f92672>=</span> MiniRacer()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Direct object and array access!</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> obj <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;let obj = {&#34;foo&#34;: &#34;bar&#34;}; obj&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> obj[<span style=color:#e6db74>&#34;foo&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;bar&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> obj[<span style=color:#e6db74>&#34;baz&#34;</span>] <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;[]&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> obj[<span style=color:#e6db74>&#34;baz&#34;</span>]<span style=color:#f92672>.</span>append(<span style=color:#ae81ff>42</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;JSON.stringify(obj)&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;{&#34;foo&#34;:&#34;bar&#34;,&#34;baz&#34;:[42]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Call JS functions directly!</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> func <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;(a) =&gt; a*7&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> func(<span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Promise await support, so you can wait in two languages at once!</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>will_you_wait_just_one_second_please</span>():
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>    promise <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;new Promise((res, rej) =&gt; setTimeout(res, 1000))&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>    <span style=color:#66d9ef>await</span> promise
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> asyncio<span style=color:#f92672>.</span>run(will_you_wait_just_one_second_please())  <span style=color:#75715e># does exactly as requested!</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span></code></pre></div><p><em>Other new features can be found
<a href=https://bpcreech.com/PyMiniRacer/history/>on the relnotes page</a>, where v0.8.0
was the subject of the <a href=https://bpcreech.com/post/mini-racer/>last blog post</a>.</em></p><h2 id=new-feature-rundown>New feature rundown
<a href=#new-feature-rundown><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>First, I&rsquo;ll discuss new features for PyMiniRacer. These require an incremental
overhaul of the C++ side of PyMiniRacer, which is discussed below.</p><h3 id=manipulating-objects-and-arrays>Manipulating objects and arrays
<a href=#manipulating-objects-and-arrays><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>As of <code>v0.8.0</code> and earlier, PyMiniRacer could create and manipulate objects and
arrays only at a distance. Sure, you could easily create objects in the JS
context via <code>MiniRacer.eval</code> statements. However, getting to their <em>contents</em>
was hard!</p><p><code>MiniRacer.eval</code> could convert primitives like numbers and strings directly to
Python objects, but to get a property of an object, you had to run an evaluation
of some JS code which would extract that property, like
<code>mr.eval(my_obj["my_property"])</code> instead of simply writing
<code>my_obj["my_property"]</code> in Python. Or you could give up and <code>JSON.stringify</code> the
whole object, and <code>json.loads</code> the serialized object on the Python side.</p><p>The more you do it, the more it feels like programming with
<a href=https://en.wikipedia.org/wiki/Remote_manipulator>waldos</a>:</p><div style=text-align:center><p><img src=/img/waldos.jpg alt="A &ldquo;waldo&rdquo; or &ldquo;remote manipulator&rdquo;"></p></p><p><em>Working with Objects and Arrays in PyMiniRacer v0.8.0.
<a href=https://en.wikipedia.org/wiki/Remote_manipulator>source</a></em></p></div><p>Well, now you can directly mess with objects and arrays from Python! I added a
<a href=https://docs.python.org/3/library/collections.abc.html#collections.abc.MutableMapping><code>MutableMapping</code></a>
(<code>dict</code>-like) interface for all derivatives of JS Objects, and a
<a href=https://docs.python.org/3/library/collections.abc.html#collections.abc.MutableSequence><code>MutableSequence</code></a>
(<code>list</code>-like) interface for JS Arrays. You can now use Pythonic idioms to read
and write <code>Object</code> properties and <code>Array</code> elements in Python, including
recursively (i.e., you can read <code>Object</code>s embedded in other <code>Object</code>s, and embed
your own).</p><p>This required tracking v8 object handles within Python (instead of reading and
disposing them at the end of every <code>MiniRacer.eval</code> call), which in turn
required revamping the C++ memory management model. More on that
<a href=#relieving-python-of-the-duty-of-managing-c-memory>below</a>.</p><h3 id=direct-function-calls>Direct function calls
<a href=#direct-function-calls><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>As of <code>v0.8.0</code> and earlier, PyMiniRacer couldn&rsquo;t directly call a function. You
could only evaluate some JS code which would call your function. Passing in
function parameters was likewise awkward; you had to serialize them into JS
code. So instead of doing <code>foo(my_str, my_int)</code> in Python, you had to do
something like <code>mr.eval(f'foo("{my_str}", {my_int})')</code>. The <code>MiniRacer.call</code>
method helped with this by JSON-serializing your data for you, but the wrapper
it puts around your code isn&rsquo;t always quite right (as reported on the original
<a href=https://github.com/sqreen/PyMiniRacer>sqreen/PyMiniRacer</a> GitHub issue
tracker).</p><p>Well, now you can retrieve a function from JS, and then&mldr; just call it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> reverseString <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>function reverseString(str) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return str.split(&#34;&#34;).reverse().join(&#34;&#34;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>reverseString  // return the function
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> reverseString
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>py_mini_racer<span style=color:#f92672>.</span>py_mini_racer<span style=color:#f92672>.</span>JSFunction object at <span style=color:#ae81ff>0x7bb3dc5739a0</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> reverseString(<span style=color:#e6db74>&#34;reviled diaper&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;repaid deliver&#39;</span>
</span></span></code></pre></div><p>You can also specify <code>this</code> as a keyword argument, because JavaScript:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> get_whatever <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>function get_whatever(str) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return this.whatever;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>get_whatever  // return the function
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> obj <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#34;let obj = </span><span style=color:#e6db74>{whatever: 42}</span><span style=color:#e6db74>; obj&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> get_whatever(this<span style=color:#f92672>=</span>obj)
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span>
</span></span></code></pre></div><p>As with direct <code>Object</code> and <code>Array</code> manipulation, aside from a straightforward
exposure of C++ APIs to Python, to make this work we have to revamp the C++
object lifecyle model; more
<a href=#relieving-python-of-the-duty-of-managing-c-memory>below</a>.</p><h3 id=async-and-timeouts>Async and timeouts
<a href=#async-and-timeouts><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>It seemed like a big gap that PyMiniRacer, as of <code>v0.8.0</code> and earlier, could
create JS Promises, but couldn&rsquo;t do anything to asynchronously await them.
<a href=https://github.com/bpcreech/PyMiniRacer/issues/7>I wasn&rsquo;t the only one with this feeling</a>.
One of the PyMiniRacer tests did work with promises, but only by
<a href=https://github.com/bpcreech/PyMiniRacer/blob/5161d99a39076c36209519c9601d32546c8d276b/tests/test_eval.py#L215>polling for completion</a>.</p><p>Both Python and JavaScript have a concept of <code>async</code> code. Can we hook them up?
Yes!</p><p>Now you can create a Promise on the JS side and await it either using <code>asyncio</code>
or using a blocking <code>.get</code> call:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> promise <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;new Promise((res, rej) =&gt; setTimeout(() =&gt; res(42), 1000))&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>await</span> promise  <span style=color:#75715e># only works within Python &#34;async def&#34; functions</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> promise<span style=color:#f92672>.</span>get()  <span style=color:#75715e># works outside of python &#34;async def&#34; functions and not recommended</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span>                 <span style=color:#75715e># within async functions (because it would block up the asyncio loop)</span>
</span></span></code></pre></div><p>To make this demo work, I actually also had to write a <code>setTimeout</code> function,
which is funny because it&rsquo;s so ubiquitous you might forget that it&rsquo;s not part of
the ECMA standard, and thus not part of V8&rsquo;s standard library. (<code>setTimeout</code> is
<a href=https://developer.mozilla.org/en-US/docs/Web/API/setTimeout>a <em>web</em> standard</a>,
and also
<a href=https://nodejs.org/api/timers.html#settimeoutcallback-delay-args>exists in NodeJS</a>.
E.g., in browser scripts, <code>setTimeout</code> lives on the <code>window</code> object, but
PyMiniRacer has no <code>window</code> object.) Turns out we can write a pure-JS
<code>setTimeout</code> using only the ECMA standard libraries using
<a href=https://github.com/bpcreech/PyMiniRacer/blob/560d5ac7de6b0b92a12d7a4a8062b9392a28a1b4/src/py_mini_racer/py_mini_racer.py#L684>a somewhat hacky wrapper</a>
of
<a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Atomics/waitAsync><code>Atomics.waitAsync</code></a>.
I stole this insight from the PyMiniRacer unit tests and spun it into a
glorified <code>setTimeout</code> / <code>clearTimeout</code> wrapper in what felt like one of those
silly improbable interview questions (&ldquo;Please build thing A using only
half-broken tools B and C!&rdquo;).</p><p>Moreover, this required making PyMiniRacer better at running code indefinitely
so it would actually process the async work reliably—more on that below.</p><h2 id=changes-to-the-pyminiracer-c-backend>Changes to the PyMiniRacer C++ backend
<a href=#changes-to-the-pyminiracer-c-backend><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>So, the above features involve overhauling PyMiniRacer. Let&rsquo;s talk about how I
did that!</p><h3 id=clang-tidy><code>clang-tidy</code>
<a href=#clang-tidy><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>First, before getting into C++ changes, I wanted to inherit the best of
automated wisdom about how to write C++. I personally have been writing C++ for
over two decades, but having taken a break from it for 5 years, I missed out on
the fun of both C++17 and C++20!</p><p>So I added
<a href=https://github.com/bpcreech/PyMiniRacer/blob/560d5ac7de6b0b92a12d7a4a8062b9392a28a1b4/.pre-commit-config.yaml#L36>a <code>clang-tidy</code> pre-commit</a>.
As well as a <code>clang-format</code> pre-commit, because duh. Some observations:</p><ol><li><code>clang-tidy</code> has taught me lots of things I didn&rsquo;t know, e.g., when to
<code>std::move</code> stuff and when to rely on
<a href=https://en.cppreference.com/w/cpp/language/copy_elision>guaranteed copy elision</a>,
and how to annoy others by using
<a href=https://en.wikipedia.org/wiki/Trailing_return_type>trailing return types</a>
<em>everywhere, absolutely everywhere</em>.</li><li>It continually catches my mistakes, like extra copies, extra lambda
parameters, and whatnot!</li><li>There is unfortunately no good set of recommended <code>clang-tidy</code> checks
everyone should enable (as compared to ESLint for JavaScript, Ruff for
Python, etc, which work pretty well out of the box). Some bundled checks are
broadly useful for most everyone, and some are are clearly only intended for
a limited audience. E.g., the llvm checks are doomed to fail if you&rsquo;re not
<em>writing llvm itself</em>. The <code>altera</code> checks are intended for people writing
code for FGPAs. The <code>fuschia</code> checks have some very unusual opinions that I&rsquo;m
sure make sense for the Fuschia project but I cannot imagine there is
consenus that, e.g., defaults in function parameters are bad. So everyone
using <code>clang-tidy</code> has to figure out, by trial and error, which checks have
weird non-applicable opinions and thus have to be disabled.</li><li>The memory management checks seem unhelpful in that I, like most C++
programmers, use smart pointers <em>everywhere</em>, so when the checks fail it&rsquo;s
just noise 100% of the time so far. It seems like these complicated
memory-tracking checks could almost be simplified into &ldquo;uh you used new or
delete without a shared pointer&rdquo;, and then would only <em>usefully</em> trigger for
novice C++ programmers.</li><li><code>clang-tidy</code> is slow; something like 100 times slower than <code>clang</code> itself. It
takes about 20 minutes on my old laptop to run over PyMiniRacer, which is
only 29 small files.</li></ol><p>Anyway, <code>clang-tidy</code> is super useful; would recommend!</p><h3 id=inverting-pyminiracers-threading-model>Inverting PyMiniRacer&rsquo;s threading model
<a href=#inverting-pyminiracers-threading-model><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>So, to start off, for <code>async</code> code to work correctly in PyMiniRacer (and also,
to run code off the Python thread, thus enabling <code>KeyboardInterrupt</code> of
PyMiniRacer JS code), we need V8 to execute code <em>continually</em>, e.g., to process
delayed callbacks from <code>setTimeout</code>. In other words, if we want to be able to
use <code>setTimeout</code> to schedule work for <code>N</code> seconds from now, and have it
actually, you know, <em>run</em> that delayed work, we need to convince V8 to actually
run, continually, until explicitly shut down.</p><p>However, PyMiniRacer was set up like <em>both</em> of V8&rsquo;s
<a href=https://v8.github.io/api/head/examples.html>extensive list of two samples</a>. It
ran a thing once, and pumped the V8 message loop a bit, and quit, never to call
V8 again (until the next user input). This seems odd: how do you know there is
no delayed work? I guess you just assume there&rsquo;s no delayed work. But at the
same time, programs like Chrome, which
<a href=https://backlinko.com/chrome-users>a few people use</a>, and NodeJS,
<a href=https://radixweb.com/blog/nodejs-usage-statistics>likewise</a>, obviously use V8
in continually-operating form. How do we do it?</p><p>A couple facts make &ldquo;how do we do it&rdquo; tricky to answer:</p><ol><li>The <code>v8::Isolate</code>, the environment in which all your JS code runs, is not
inherently thread-safe. You need to grab a <code>v8::Locker</code> first to use it
safely.</li><li><code>v8::platform::PumpMessageLoop</code>, the thing that powers all work beyond an
initial code evaluation in V8, needs the <code>v8::Isolate</code> lock. However, it does
not actually <em>ask for</em> the lock. It does not release the lock either,
apparently. And yet we need it to run, continually and without returning
control to us. We have to use its wait-for-work mode, (unless we want to
<a href=https://en.wikipedia.org/wiki/Busy_waiting>use a lot of electricity</a>),
which means the message pump is doomed to sit around a lot, doing nothing but
hogging the <code>v8::Isolate</code> lock.</li></ol><p>So you need to get the lock to use the <code>Isolate</code>, but you also need to spend a
lot of time calling this thing (<code>PumpMessageLoop</code>) hogs that lock. How do you
reconcile these?</p><p>My solution was inspired by <a href=https://v8.dev/docs/d8>the <code>d8</code> tool</a>, which ships
with V8: all code which interacts with the <code>Isolate</code> is
<a href=https://github.com/v8/v8/blob/2ce051bb21edff5e66c4e87180c9d90b18fdf526/include/v8-platform.h#L82>&ldquo;posted&rdquo; as a &ldquo;task&rdquo;</a>
on the <code>Isolate</code>&rsquo;s <code>TaskRunner</code>. Then it will run <em>under</em> the <code>PumpMessageLoop</code>
call, where <em>it already has that <code>Isolate</code> lock which <code>PumpMessageLoop</code> has been
hogging</em>. Nobody needs to grab the <code>Isolate</code> lock, because <em>they already have
it</em>, having been sequenced into the <code>PumpMessageLoop</code> thread as tasks.</p><p>This seems to work, but involved reorganizing all of PyMiniRacer, inverting
control such that a thread running <code>PumpMessageLoop</code> is the center of the
universe, and everything else just asks it to do work. Even things like &ldquo;hey I&rsquo;d
like to delete this object handle&rdquo; need to be put onto the <code>v8::Isolate</code>&rsquo;s task
queue.</p><p>The resulting setup looks roughly like this:</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 568 457"><g transform="translate(8,16)"><path d="M0 0H552" fill="none" stroke="currentcolor"/><path d="M176 48H520" fill="none" stroke="currentcolor"/><path d="M328 96H440" fill="none" stroke="currentcolor"/><path d="M280 112h40" fill="none" stroke="currentcolor"/><path d="M120 160h40" fill="none" stroke="currentcolor"/><path d="M160 160H328" fill="none" stroke="currentcolor"/><path d="M328 176h24" fill="none" stroke="currentcolor"/><path d="M352 176h88" fill="none" stroke="currentcolor"/><path d="M176 272H536" fill="none" stroke="currentcolor"/><path d="M0 304H48" fill="none" stroke="currentcolor"/><path d="M48 304H552" fill="none" stroke="currentcolor"/><path d="M0 368H48" fill="none" stroke="currentcolor"/><path d="M48 368H216" fill="none" stroke="currentcolor"/><path d="M320 368H512" fill="none" stroke="currentcolor"/><path d="M216 4e2h96" fill="none" stroke="currentcolor"/><path d="M0 432H216" fill="none" stroke="currentcolor"/><path d="M320 432H512" fill="none" stroke="currentcolor"/><path d="M0 0V304" fill="none" stroke="currentcolor"/><path d="M0 368v64" fill="none" stroke="currentcolor"/><path d="M48 176V304" fill="none" stroke="currentcolor"/><path d="M48 304v64" fill="none" stroke="currentcolor"/><path d="M160 64v96" fill="none" stroke="currentcolor"/><path d="M160 160v96" fill="none" stroke="currentcolor"/><path d="M216 368v32" fill="none" stroke="currentcolor"/><path d="M216 4e2v32" fill="none" stroke="currentcolor"/><path d="M320 368v64" fill="none" stroke="currentcolor"/><path d="M328 96v64" fill="none" stroke="currentcolor"/><path d="M328 160v16" fill="none" stroke="currentcolor"/><path d="M352 176v32" fill="none" stroke="currentcolor"/><path d="M384 192v16" fill="none" stroke="currentcolor"/><path d="M440 96v80" fill="none" stroke="currentcolor"/><path d="M512 368v64" fill="none" stroke="currentcolor"/><path d="M536 64V272" fill="none" stroke="currentcolor"/><path d="M552 0V304" fill="none" stroke="currentcolor"/><polygon points="56.000000,176.000000 44.000000,170.399994 44.000000,181.600006" fill="currentcolor" transform="rotate(270.000000, 48.000000, 176.000000)"/><polygon points="128.000000,160.000000 116.000000,154.399994 116.000000,165.600006" fill="currentcolor" transform="rotate(180.000000, 120.000000, 160.000000)"/><polygon points="320.000000,400.000000 308.000000,394.399994 308.000000,405.600006" fill="currentcolor" transform="rotate(0.000000, 312.000000, 400.000000)"/><polygon points="328.000000,112.000000 316.000000,106.400002 316.000000,117.599998" fill="currentcolor" transform="rotate(0.000000, 320.000000, 112.000000)"/><path d="M384 184v8" fill="none" stroke="currentcolor"/><polygon points="400.000000,192.000000 388.000000,186.399994 388.000000,197.600006" fill="currentcolor" transform="rotate(270.000000, 384.000000, 192.000000)"/><path d="M176 48A16 16 0 00160 64" fill="none" stroke="currentcolor"/><path d="M520 48a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M352 208a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M384 208a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><path d="M160 256a16 16 0 0016 16" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="16" y="164" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="16" y="404" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="24" y="164" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="24" y="404" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="32" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="32" y="404" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="40" y="164" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="40" y="404" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="48" y="164" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="48" y="404" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="56" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="56" y="404" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="164" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="64" y="196" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="64" y="324" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="64" y="404" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="72" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="72" y="196" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="72" y="324" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="72" y="404" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="80" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="80" y="404" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="80" y="420" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="88" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="88" y="324" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="88" y="404" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="88" y="420" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="96" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="96" y="196" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="324" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="96" y="340" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="96" y="404" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="96" y="420" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="104" y="164" fill="currentcolor" style="font-size:1em">*</text><text text-anchor="middle" x="104" y="196" fill="currentcolor" style="font-size:1em">q</text><text text-anchor="middle" x="104" y="324" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="104" y="340" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="104" y="404" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="104" y="420" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="112" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="112" y="324" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="340" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="112" y="404" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="420" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="120" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="324" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="120" y="340" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="120" y="404" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="128" y="196" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="128" y="324" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="340" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="128" y="404" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="196" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="324" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="136" y="340" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="136" y="404" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="144" y="196" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="144" y="324" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="144" y="340" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="404" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="152" y="324" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="152" y="340" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="152" y="404" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="160" y="324" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="160" y="340" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="160" y="404" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="168" y="324" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="168" y="340" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="168" y="404" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="176" y="68" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="324" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="176" y="340" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="176" y="404" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="20" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="184" y="116" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="184" y="148" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="184" y="228" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="184" y="324" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="184" y="404" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="192" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="192" y="68" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="192" y="116" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="192" y="148" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="192" y="228" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="192" y="324" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="192" y="404" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="200" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="200" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="200" y="324" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="200" y="404" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="208" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="208" y="68" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="208" y="116" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="208" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="208" y="228" fill="currentcolor" style="font-size:1em">…</text><text text-anchor="middle" x="208" y="244" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="208" y="260" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="208" y="324" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="216" y="20" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="216" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="216" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="216" y="148" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="216" y="244" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="216" y="260" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="216" y="324" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="224" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="68" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="224" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="224" y="148" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="224" y="228" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="224" y="244" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="224" y="260" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="224" y="324" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="232" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="232" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="232" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="232" y="148" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="232" y="228" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="232" y="244" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="232" y="260" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="232" y="324" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="232" y="420" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="240" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="240" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="240" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="240" y="148" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="240" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="240" y="244" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="240" y="260" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="240" y="324" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="240" y="420" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="248" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="248" y="68" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="248" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="248" y="244" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="248" y="260" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="248" y="324" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="256" y="20" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="256" y="68" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="256" y="116" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="256" y="148" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="256" y="244" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="256" y="324" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="420" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="264" y="20" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="264" y="68" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="264" y="116" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="264" y="148" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="264" y="228" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="264" y="244" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="264" y="260" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="264" y="324" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="264" y="420" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="272" y="20" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="272" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="272" y="228" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="272" y="244" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="272" y="324" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="272" y="420" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="280" y="20" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="280" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="280" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="280" y="244" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="280" y="260" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="280" y="324" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="280" y="420" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="288" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="288" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="288" y="228" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="288" y="244" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="288" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="288" y="420" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="296" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="296" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="296" y="244" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="296" y="260" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="296" y="420" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="304" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="304" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="304" y="244" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="304" y="260" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="304" y="420" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="312" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="312" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="312" y="244" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="312" y="260" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="320" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="320" y="68" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="320" y="244" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="328" y="20" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="328" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="328" y="244" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="328" y="260" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="336" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="336" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="336" y="244" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="336" y="260" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="336" y="404" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="344" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="344" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="344" y="132" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="344" y="244" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="344" y="260" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="344" y="404" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="352" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="352" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="352" y="132" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="352" y="244" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="352" y="260" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="352" y="404" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="360" y="20" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="360" y="68" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="360" y="132" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="360" y="244" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="360" y="260" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="360" y="404" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="368" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="368" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="368" y="132" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="368" y="244" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="368" y="260" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="368" y="404" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="376" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="376" y="68" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="376" y="132" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="376" y="244" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="376" y="260" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="376" y="404" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="384" y="68" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="384" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="384" y="244" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="384" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="384" y="404" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="392" y="68" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="392" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="392" y="244" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="392" y="260" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="392" y="404" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="400" y="68" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="400" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="400" y="244" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="400" y="404" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="408" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="408" y="244" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="408" y="404" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="416" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="416" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="416" y="404" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="424" y="68" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="424" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="424" y="404" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="432" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="432" y="404" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="440" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="440" y="404" fill="currentcolor" style="font-size:1em">H</text><text text-anchor="middle" x="448" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="448" y="404" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="456" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="456" y="404" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="464" y="404" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="472" y="404" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="480" y="404" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="488" y="404" fill="currentcolor" style="font-size:1em">k</text></g></svg></div><p>Reading that diagram in order:</p><ol><li>The <code>MiniRacer::IsolateMessagePump</code> runs a thread which creates a
<code>v8::Isolate</code>,</li><li>&mldr; exposes it to the <code>MiniRacer::IsolateManager</code>,</li><li>&mldr; and loops on <code>v8::platform::PumpMessageLoop</code> until shutdown.</li><li>Then, any code which wants to <em>use</em> the <code>Isolate</code>, such as
<code>MiniRacer::CodeEvaluator</code> (the class which implements the <code>MiniRacer.eval</code>
function to run arbitrary JS code) can package up tasks into
<code>MiniRacer::AdHocTask</code> and</li><li>&mldr; throw them onto the <code>Isolate</code> work queue to actually run, on the
message-pumping thread.</li></ol><h4 id=stdshared_ptr-all-the-things><code>std::shared_ptr</code> all the things!
<a href=#stdshared_ptr-all-the-things><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h4><p>Our control inversion to an event-driven design (explained above) is complicated
to pull off safely in C++, where object lifecycle is up to the developer. Since
everything is event-driven, we have to be very careful to control the lifecycle
of every object, ensuring objects outlive all the tasks which reference them.
After trying to explicitly control everything, I gave up and
<a href=https://github.com/bpcreech/PyMiniRacer/pull/38>settled on</a> basically using
<code>std::shared_ptr</code> to manage lifecycle for just about everything (regressing to
&ldquo;C++ developer phase 1&rdquo; as described
<a href=https://www.reddit.com/r/cpp_questions/comments/17tl7oh/best_practice_smart_pointer_use/>here</a>).
If a task has a <code>std::shared_ptr</code> pointing to all the objects it needs to run,
the objects are guaranteed to still be around when the task runs. This in turn
involves some refactoring of classes, to ensure there are no references cycles
when we implement this strategy. Reference cycles and <code>std::shared_ptr</code> do not
get along.</p><h4 id=threading-in-summary>Threading, in summary
<a href=#threading-in-summary><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h4><p>The above story seems like it should be common to most use of V8, yet all seems
underdocumented in V8. The solution I landed on involved some educated guesses
about thread safety of V8 components (like, can you safely add a task to the
<code>Isolate</code>&rsquo;s foreground task runner without the <code>Isolate</code> lock? The
implementation seems to say so, but the docs&mldr; don&rsquo;t exist! Does
<code>v8::platform::PumpMessageLoop</code> need the lock? It seems to crash when I don&rsquo;t
have it; core files are a form of library documentation I guess, but maybe I was
simply holding it wrong when it crashed?) I have
<a href=https://groups.google.com/g/v8-users/c/glG3-3pufCo/m/-rSSMTLEAAAJ>put a question to the v8-users group</a>
to see if I can get any confirmation of my assumptions here.</p><h3 id=relieving-python-of-the-duty-of-managing-c-memory>Relieving Python of the duty of managing C++ memory
<a href=#relieving-python-of-the-duty-of-managing-c-memory><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>There are 5 places where Python and C++ need to talk about objects in memory:</p><ol><li><p>The overall MiniRacer context object which creates and owns everything
(including the <code>v8::Isolate</code> discussed above).</p></li><li><p>JS values created by MiniRacer and passed back to Python (and, when we start
doing mutable objects or function calls, <em>JS values created in Python and
passed into JS</em>!).</p></li><li><p>Callback function addresses from C++ to Python.</p></li><li><p>Callback context to go along with the above, so that when Python receives a
callback it understands what the callback is about. (E.g., we typically use a
Python-side <code>Future</code> as the callback context here; the callback sends both
<em>data</em> and <em>context</em>. The callback function just has to take the <em>data</em>,
i.e., a result value, and stuff it into a <code>Future</code>, which it conveniently can
find given the callback&rsquo;s <em>context</em>.)</p></li><li><p>Task handles for long-running <code>eval</code> tasks, so we can cancel them.</p></li></ol><p>While <a href=https://docs.python.org/3/library/gc.html>Python&rsquo;s garbage collector</a>
tracks references and automatically deletes unreachable <em>Python</em> objects, if
you&rsquo;re extending Python with C (or C++) code, you have to explicitly delete the
C/C++ objects. There are kinda two approaches for systematically ensuring
deletion happens:</p><ol><li><p><strong><code>with</code> statements:</strong></p><p>You can treat C++ objects as external resources and use
<a href=https://peps.python.org/pep-0343/>`with statements and context managers</a> to
explicitly manage object lifecycle, in user code. There is
<a href=https://stackoverflow.com/questions/1481488/what-is-the-del-method-and-how-do-i-call-it#answer-1481512>an absolutist view</a>
(previously held by me after being burned by finalizers before; see below)
that this is the only way proper way to manage external resources (<em>but are
in-process C++ objects really &ldquo;external resources&rdquo;?</em>). Code using context
managers to explicitly deallocate all allocated objects would look like, in
absolutist form:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>with</span> MiniRacer() <span style=color:#66d9ef>as</span> mr:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>with</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#34;[]&#34;</span>) <span style=color:#66d9ef>as</span> array:
</span></span><span style=display:flex><span>     array<span style=color:#f92672>.</span>append(<span style=color:#ae81ff>42</span>)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>with</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;JSON.stringify&#39;</span>) <span style=color:#66d9ef>as</span> stringify_function:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> stringify_function(array) <span style=color:#66d9ef>as</span> stringified:
</span></span><span style=display:flex><span>           print(stringified)  <span style=color:#75715e># prints &#39;[42]&#39;</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e># at this point, the value behind &#34;stringified&#34; is freed by calling a C API.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># at this point, the value behind &#34;stringify_function&#34; is freed by calling a C API.</span>
</span></span><span style=display:flex><span>     <span style=color:#75715e># at this point, the value behind &#34;array&#34; is freed by calling a C API.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># at this point, the MiniRacer context is freed by calling a C API.</span>
</span></span></code></pre></div><p><em>(Astute Pythonistas may note that two of those <code>with</code> statements could be
collapsed into one to make it &ldquo;simpler&rdquo;. Yay.)</em></p><p>This is nicely explicit, but extremely annoying to use. (I actually
implemented this, but undid it when I started updating the PyMiniRacer
<code>README</code> and saw how annoying it is.)</p></li><li><p><strong>Finalizers, aka
<a href=https://docs.python.org/3/reference/datamodel.html#object.__del__>the <code>__del__</code> method</a>:</strong></p><p>You can create a Python-native wrapper class whose <code>__del__</code> method frees the
underlying C++ resource. This looks like, e.g.:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>_Context</span>:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> __init__(self, dll):
</span></span><span style=display:flex><span>     self<span style=color:#f92672>.</span>dll <span style=color:#f92672>=</span> dll  <span style=color:#75715e># (&#34;dll&#34; here comes from the ctypes API)</span>
</span></span><span style=display:flex><span>     self<span style=color:#f92672>.</span>_c_object <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>dll<span style=color:#f92672>.</span>mr_init_context()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> __del__(self):
</span></span><span style=display:flex><span>     self<span style=color:#f92672>.</span>dll<span style=color:#f92672>.</span>mr_free_context(self<span style=color:#f92672>.</span>_c_object)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Then user code doesn&rsquo;t have to remember to free things at all! <em>What could go
possibly wrong?</em></p><center><div style=max-width:300px><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 296 89"><g transform="translate(8,16)"><path d="M0 0H120" fill="none" stroke="currentcolor"/><path d="M160 0H280" fill="none" stroke="currentcolor"/><path d="M120 16h32" fill="none" stroke="currentcolor"/><path d="M128 48h32" fill="none" stroke="currentcolor"/><path d="M0 64H120" fill="none" stroke="currentcolor"/><path d="M160 64H280" fill="none" stroke="currentcolor"/><path d="M0 0V64" fill="none" stroke="currentcolor"/><path d="M120 0V16" fill="none" stroke="currentcolor"/><path d="M120 16V64" fill="none" stroke="currentcolor"/><path d="M160 0V48" fill="none" stroke="currentcolor"/><path d="M160 48V64" fill="none" stroke="currentcolor"/><path d="M280 0V64" fill="none" stroke="currentcolor"/><polygon points="136.000000,48.000000 124.000000,42.400002 124.000000,53.599998" fill="currentcolor" transform="rotate(180.000000, 128.000000, 48.000000)"/><polygon points="160.000000,16.000000 148.000000,10.400000 148.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 152.000000, 16.000000)"/><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="48" y="36" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="80" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="200" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="248" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="256" y="36" fill="currentcolor" style="font-size:1em">)</text></g></svg></div></div></center></li></ol><h4 id=the-trouble-with-finalizers>The trouble with finalizers
<a href=#the-trouble-with-finalizers><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h4><p><em>What could possibly go wrong</em> is that finalizers are called somewhat lazily by
Python, and in kind of unpredictable order. This problem is shared by Java,
<a href=https://stackoverflow.com/questions/30368849/destructor-execution-order>C#</a>
and I assume every other garbage-collected language which supports finalizers:
if you have two objects <code>A</code> and <code>B</code> which refer to each other (aka a reference
cycle), but which are obviously otherwise unreachable, obviously you should
garbage-collect them.</p><p>But if <em>both</em> <code>A</code> and <code>B</code> have finalizers, which do you call first? If you call
<code>A</code>&rsquo;s finalizer, great, but later <code>B</code>&rsquo;s finalizer might try and reach out to
<code>A</code>, <em>which has already been finalized!</em> Likewise, if you finalize <code>B</code> first,
then <code>A</code>&rsquo;s finalizer might try and reach out to <code>B</code> which is already gone. You
can&rsquo;t win! So if you&rsquo;re the Python garbage collector, you just call the
finalizers for both objects, in <em>whatever</em> order you like, and you declare it to
be programmer error if these objects refer to each other in their finalizers,
and you generally <em>declare that finalization order doesn&rsquo;t matter</em>.</p><center><div style=text-align:center;max-width:400px><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 392 233"><g transform="translate(8,16)"><path d="M48 0H168" fill="none" stroke="currentcolor"/><path d="M208 0H328" fill="none" stroke="currentcolor"/><path d="M168 16h32" fill="none" stroke="currentcolor"/><path d="M176 48h32" fill="none" stroke="currentcolor"/><path d="M48 64h64" fill="none" stroke="currentcolor"/><path d="M112 64h56" fill="none" stroke="currentcolor"/><path d="M208 64h64" fill="none" stroke="currentcolor"/><path d="M272 64h56" fill="none" stroke="currentcolor"/><path d="M48 144H168" fill="none" stroke="currentcolor"/><path d="M208 144H328" fill="none" stroke="currentcolor"/><path d="M168 176h32" fill="none" stroke="currentcolor"/><path d="M48 208H168" fill="none" stroke="currentcolor"/><path d="M208 208H328" fill="none" stroke="currentcolor"/><path d="M48 0V64" fill="none" stroke="currentcolor"/><path d="M48 144v64" fill="none" stroke="currentcolor"/><path d="M112 64v64" fill="none" stroke="currentcolor"/><path d="M168 0V16" fill="none" stroke="currentcolor"/><path d="M168 16V64" fill="none" stroke="currentcolor"/><path d="M168 144v32" fill="none" stroke="currentcolor"/><path d="M168 176v32" fill="none" stroke="currentcolor"/><path d="M208 0V48" fill="none" stroke="currentcolor"/><path d="M208 48V64" fill="none" stroke="currentcolor"/><path d="M208 144v64" fill="none" stroke="currentcolor"/><path d="M272 64v64" fill="none" stroke="currentcolor"/><path d="M328 0V64" fill="none" stroke="currentcolor"/><path d="M328 144v64" fill="none" stroke="currentcolor"/><path d="M112 128v8" fill="none" stroke="currentcolor"/><polygon points="128.000000,128.000000 116.000000,122.400002 116.000000,133.600006" fill="currentcolor" transform="rotate(90.000000, 112.000000, 128.000000)"/><polygon points="184.000000,48.000000 172.000000,42.400002 172.000000,53.599998" fill="currentcolor" transform="rotate(180.000000, 176.000000, 48.000000)"/><polygon points="208.000000,16.000000 196.000000,10.400000 196.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 200.000000, 16.000000)"/><polygon points="208.000000,176.000000 196.000000,170.399994 196.000000,181.600006" fill="currentcolor" transform="rotate(0.000000, 200.000000, 176.000000)"/><path d="M272 128v8" fill="none" stroke="currentcolor"/><polygon points="288.000000,128.000000 276.000000,122.400002 276.000000,133.600006" fill="currentcolor" transform="rotate(90.000000, 272.000000, 128.000000)"/><text text-anchor="middle" x="0" y="84" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="0" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="0" y="116" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="8" y="84" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="8" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="8" y="116" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="16" y="84" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="16" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="16" y="116" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="24" y="84" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="24" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="32" y="84" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="32" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="32" y="116" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="40" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="40" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="40" y="116" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="48" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="48" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="84" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="56" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="56" y="116" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="64" y="84" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="64" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="64" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="84" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="72" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="80" y="84" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="80" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="88" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="88" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="96" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="104" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="112" y="180" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="120" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="128" y="84" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="128" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="136" y="84" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="136" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="144" y="84" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="144" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="152" y="84" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="152" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="160" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="160" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="168" y="84" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="176" y="84" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="176" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="184" y="84" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="184" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="192" y="84" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="192" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="200" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="208" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="216" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="224" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="232" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="240" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="248" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="256" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="264" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="272" y="36" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="272" y="180" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="280" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="288" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="296" y="84" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="296" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="304" y="84" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="304" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="312" y="84" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="312" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="320" y="84" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="320" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="328" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="328" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="336" y="84" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="336" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="344" y="84" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="344" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="352" y="84" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="352" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="360" y="84" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="360" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="368" y="100" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="376" y="100" fill="currentcolor" style="font-size:1em">·</text></g></svg></div></div></center><p>Unfortunately, <em>order sometimes matters</em>. Let&rsquo;s say those objects <code>A</code> and <code>B</code>
are each managing C++ objects, <code>C</code> and <code>D</code>, respectively, as depicted above.
Obviously, in the above picture, we should tear down <code>C</code> before <code>D</code> so we don&rsquo;t
leave a dangling reference from <code>C</code> to <code>D</code>. The best teardown order here is:
<code>A</code>, <code>C</code>, <code>B</code>, <em>then</em> <code>D</code>. But <em>Python doesn&rsquo;t know that</em>! It has no idea about
the link between C++ objects <code>C</code> and <code>D</code>. It is likely to call <code>B</code>&rsquo;s finalizer
first, tearing down <code>D</code> before <code>C</code>, thus leaving a dangling reference on the C++
side.</p><center><div style=text-align:center;max-width:600px><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 584 377"><g transform="translate(8,16)"><path d="M24 0H272" fill="none" stroke="currentcolor"/><path d="M312 0H528" fill="none" stroke="currentcolor"/><path d="M272 16h32" fill="none" stroke="currentcolor"/><path d="M280 48h32" fill="none" stroke="currentcolor"/><path d="M24 64h88" fill="none" stroke="currentcolor"/><path d="M112 64H272" fill="none" stroke="currentcolor"/><path d="M312 64h32" fill="none" stroke="currentcolor"/><path d="M344 64H528" fill="none" stroke="currentcolor"/><path d="M24 176H272" fill="none" stroke="currentcolor"/><path d="M312 176H528" fill="none" stroke="currentcolor"/><path d="M24 240H160" fill="none" stroke="currentcolor"/><path d="M160 240H272" fill="none" stroke="currentcolor"/><path d="M312 240H416" fill="none" stroke="currentcolor"/><path d="M416 240H528" fill="none" stroke="currentcolor"/><path d="M312 288H528" fill="none" stroke="currentcolor"/><path d="M160 320H304" fill="none" stroke="currentcolor"/><path d="M312 352H528" fill="none" stroke="currentcolor"/><path d="M24 0V64" fill="none" stroke="currentcolor"/><path d="M24 176v64" fill="none" stroke="currentcolor"/><path d="M112 64v96" fill="none" stroke="currentcolor"/><path d="M160 240v80" fill="none" stroke="currentcolor"/><path d="M272 0V16" fill="none" stroke="currentcolor"/><path d="M272 16V64" fill="none" stroke="currentcolor"/><path d="M272 176v64" fill="none" stroke="currentcolor"/><path d="M312 0V48" fill="none" stroke="currentcolor"/><path d="M312 48V64" fill="none" stroke="currentcolor"/><path d="M312 176v64" fill="none" stroke="currentcolor"/><path d="M312 288v64" fill="none" stroke="currentcolor"/><path d="M344 64v96" fill="none" stroke="currentcolor"/><path d="M416 240v32" fill="none" stroke="currentcolor"/><path d="M528 0V64" fill="none" stroke="currentcolor"/><path d="M528 176v64" fill="none" stroke="currentcolor"/><path d="M528 288v64" fill="none" stroke="currentcolor"/><path d="M112 160v8" fill="none" stroke="currentcolor"/><polygon points="128.000000,160.000000 116.000000,154.399994 116.000000,165.600006" fill="currentcolor" transform="rotate(90.000000, 112.000000, 160.000000)"/><polygon points="288.000000,48.000000 276.000000,42.400002 276.000000,53.599998" fill="currentcolor" transform="rotate(180.000000, 280.000000, 48.000000)"/><polygon points="312.000000,16.000000 300.000000,10.400000 300.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 304.000000, 16.000000)"/><polygon points="312.000000,320.000000 300.000000,314.399994 300.000000,325.600006" fill="currentcolor" transform="rotate(0.000000, 304.000000, 320.000000)"/><path d="M344 160v8" fill="none" stroke="currentcolor"/><polygon points="360.000000,160.000000 348.000000,154.399994 348.000000,165.600006" fill="currentcolor" transform="rotate(90.000000, 344.000000, 160.000000)"/><path d="M416 272v8" fill="none" stroke="currentcolor"/><polygon points="432.000000,272.000000 420.000000,266.399994 420.000000,277.600006" fill="currentcolor" transform="rotate(90.000000, 416.000000, 272.000000)"/><text text-anchor="middle" x="0" y="100" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="0" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="0" y="132" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="8" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="8" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="8" y="132" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="16" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="16" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="16" y="132" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="24" y="100" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="24" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="32" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="32" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="32" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="40" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="40" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="40" y="132" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="48" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="48" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="100" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="56" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="56" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="64" y="100" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="64" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="64" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="212" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="72" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="72" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="72" y="212" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="80" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="80" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="80" y="212" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="88" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="88" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="88" y="212" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="96" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="96" y="212" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="104" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="104" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="112" y="212" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="120" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="120" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="128" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="128" y="100" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="128" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="128" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="128" y="148" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="128" y="212" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="136" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="136" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="136" y="148" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="136" y="212" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="144" y="36" fill="currentcolor" style="font-size:1em">H</text><text text-anchor="middle" x="144" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="144" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="144" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="144" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="212" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="152" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="152" y="100" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="152" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="152" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="152" y="148" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="152" y="212" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="160" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="160" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="160" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="160" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="160" y="212" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="168" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="168" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="168" y="148" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="168" y="212" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="176" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="176" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="176" y="132" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="176" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="176" y="260" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="184" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="184" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="184" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="184" y="148" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="184" y="212" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="184" y="260" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="192" y="100" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="192" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="192" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="192" y="148" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="192" y="212" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="192" y="260" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="200" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="200" y="132" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="200" y="148" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="200" y="212" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="200" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="208" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="208" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="148" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="208" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="260" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="216" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="216" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="216" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="216" y="212" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="216" y="260" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="224" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="224" y="132" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="224" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="224" y="212" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="232" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="232" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="232" y="148" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="232" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="232" y="260" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="240" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="240" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="240" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="248" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="248" y="132" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="248" y="260" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="256" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="256" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="256" y="260" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="264" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="264" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="272" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="272" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="280" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="288" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="296" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="304" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="312" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="320" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="328" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="336" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="352" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="352" y="212" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="360" y="100" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="360" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="360" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="360" y="148" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="360" y="212" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="368" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="368" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="368" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="368" y="148" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="368" y="212" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="376" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="376" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="376" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="376" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="376" y="212" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="384" y="100" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="384" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="384" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="384" y="148" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="384" y="212" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="384" y="324" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="392" y="36" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="392" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="392" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="392" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="392" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="392" y="324" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="400" y="36" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="400" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="400" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="400" y="148" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="400" y="212" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="400" y="324" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="408" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="408" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="408" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="408" y="132" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="408" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="408" y="324" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="416" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="416" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="416" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="416" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="416" y="148" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="416" y="212" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="416" y="324" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="424" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="424" y="100" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="424" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="424" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="424" y="148" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="424" y="212" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="424" y="324" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="432" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="432" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="432" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="432" y="148" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="432" y="212" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="432" y="260" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="432" y="324" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="440" y="36" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="440" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="440" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="440" y="148" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="440" y="212" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="440" y="260" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="440" y="324" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="448" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="448" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="448" y="132" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="448" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="448" y="212" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="448" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="448" y="324" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="456" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="456" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="456" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="456" y="212" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="456" y="260" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="456" y="324" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="464" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="464" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="464" y="148" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="464" y="212" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="464" y="324" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="472" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="472" y="132" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="472" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="480" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="480" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="480" y="212" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="488" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="488" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="488" y="212" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="496" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="496" y="132" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="504" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="504" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="512" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="512" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="520" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="520" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="528" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="536" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="544" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="552" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="560" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="568" y="116" fill="currentcolor" style="font-size:1em">·</text></g></svg></div></div></center><p>This happens in practice in MiniRacer: a Python <code>_Context</code> wraps a
<code>MiniRacer::Context</code>, and a Python <code>_ValueHandle</code> wraps a
<code>MiniRacer::BinaryValue</code>. But within C++ land, that <code>MiniRacer::Context</code> is what
created those <code>MiniRacer::BinaryValue</code> objects, and they each know have pointers
into the <code>v8::Isolate</code> object which the <code>Context</code> owns. If you free the
<code>MiniRacer::Context</code> before you free the <em>values pointing into its
<code>v8::Isolate</code></em>, things get very crashy, fast. We <em>want</em> Python to free all the
<code>_ValueHandle</code> objects <em>before</em> the <code>_Context</code>, but there&rsquo;s no way to tell it
that, and worse, the garbage collection ordering is nondeterministic, so it will
get it wrong, and crash, <em>randomly</em>.</p><p>The same situation arises for task handles (<code>MiniRacer::CancelableTaskHandle</code> in
C++), and we have other more mundane risky use of pointers and Python-owned
memory with callback function pointers and callback context data.</p><p>When I started work on it, MiniRacer tracked raw C++ pointers for the MiniRacer
context <em>only</em>, using <code>__del__</code> to clean it up. It only used values ephemerally,
converting and cleaning them up immediately (except for <code>memoryview</code> objects
into
<a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer>JS <code>ArrayBuffers</code></a>
but that was a rare case). If you&rsquo;re only using finalizers with one type of
object, and instances of that object don&rsquo;t interact, the reference cycle problem
explained above doesn&rsquo;t exist.</p><p>This worked fine until&mldr; I introduced more object types (async tasks, callback
functions, callback contexts, and persistent values to track <code>Object</code>s and
<code>Array</code>s). More object types means more opportunities for Python to call
finalizers <em>in the wrong order</em>.</p><h4 id=making-finalizers-safe>Making finalizers safe
<a href=#making-finalizers-safe><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h4><p>So the principle I derive from the above: <em><strong>we must refactor things so that
finalizer order doesn&rsquo;t matter</strong></em>. But how do we do it? And otherwise make our
Python/C++ boundary safe from memory management bugs?</p><p>I developed the following strategy:</p><ol><li><p>Avoid passing pointers at all. Instead, pass integer identifiers
(specifically <code>uint64_t</code>) between C++ and Python. The identifiers are all
created and registered in maps on the C++ side. The map lets the C++ side
safely validate, <em>then</em> convert from the identifier to actual object
pointers.</p><ul><li><p>Two exceptions:</p><ol><li><p>For JS values, for performance reasons, we pass a special
<code>BinaryValueHandle</code> which doubles as an identifier <em>and</em> an address
which can peek into data for primitive types. (In that case, the map key
is the <code>BinaryValueHandle</code> pointer instead of an ID. The mapped value is
the full <code>BinaryValue</code> object pointer, which is <em>not</em> directly
accessible to Python.) Note that the C++ side still validates any
<code>BinaryValueHandle</code> values passed in from Python.</p></li><li><p>For callback addresses from C++ to Python, we <em>have</em> to use a pointer.
Which then means we are at risk of
<a href=https://docs.python.org/3/library/ctypes.html#callback-functions>bugs</a>
wherein PyMiniRacer accidentally disposes the callback before the C++
side is totally done with it. C&rsquo;est la vie.)</p></li></ol></li></ul></li><li><p>Thus the C++ side can <em>check for validity of any references it receives from
Python</em>, eliminating any bugs related to use-after-free or Python freeing
things in the wrong order (i.e., freeing a whole <code>v8::Isolate</code> and only
<em>then</em> freeing a JS value which lived in that isolate).</p></li><li><p>&mldr; And the C++ side can also avoid <em>memory leaks</em>, in that when an &ldquo;owning
container&rdquo; (like the context object) is torn down, the container (on the C++
side) has a holistic view of <em>all</em> objects created within that container, and
can free any stragglers itself, on the spot.</p></li></ol><p>In this way, we <em>still use</em> <code>__del__</code> on the Python side, but <em>only</em> as an
opportunistic memory-usage-reducer. The C++ side is actually tracking all memory
usage deterministically and doesn&rsquo;t rely on Python to get it right—especially
not the order of operations when freeing things.</p><p>As a cute bonus trick, since we&rsquo;re tracking all living objects on the C++ side,
can expose methods which count them,
<a href=https://github.com/bpcreech/PyMiniRacer/blob/560d5ac7de6b0b92a12d7a4a8062b9392a28a1b4/tests/conftest.py#L7>for use in our unit tests</a>,
to ensure we don&rsquo;t have any designed memory leaks! (I
<a href=https://github.com/bpcreech/PyMiniRacer/blob/main/HISTORY.md#0111-2024-04-08>caught</a>
one pre-existing leak this way!)</p><p>The resulting setup, just looking at Contexts and JS Values, sort of looks like
the following diagram (and similar goes for async task handles):</p><center><div style=text-align:center;max-width:600px><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 624 713"><g transform="translate(8,16)"><path d="M24 0H296" fill="none" stroke="currentcolor"/><path d="M336 0H584" fill="none" stroke="currentcolor"/><path d="M296 16h32" fill="none" stroke="currentcolor"/><path d="M304 48h32" fill="none" stroke="currentcolor"/><path d="M24 64H272" fill="none" stroke="currentcolor"/><path d="M272 64h24" fill="none" stroke="currentcolor"/><path d="M336 64h32" fill="none" stroke="currentcolor"/><path d="M368 64H584" fill="none" stroke="currentcolor"/><path d="M336 192H576" fill="none" stroke="currentcolor"/><path d="M272 208h56" fill="none" stroke="currentcolor"/><path d="M336 256h96" fill="none" stroke="currentcolor"/><path d="M432 256H576" fill="none" stroke="currentcolor"/><path d="M336 304H584" fill="none" stroke="currentcolor"/><path d="M112 336H336" fill="none" stroke="currentcolor"/><path d="M336 368h88" fill="none" stroke="currentcolor"/><path d="M424 368H584" fill="none" stroke="currentcolor"/><path d="M24 416H296" fill="none" stroke="currentcolor"/><path d="M24 480H64" fill="none" stroke="currentcolor"/><path d="M64 480H296" fill="none" stroke="currentcolor"/><path d="M24 528H296" fill="none" stroke="currentcolor"/><path d="M24 592H160" fill="none" stroke="currentcolor"/><path d="M160 592H296" fill="none" stroke="currentcolor"/><path d="M312 624H528" fill="none" stroke="currentcolor"/><path d="M160 656H304" fill="none" stroke="currentcolor"/><path d="M312 688H528" fill="none" stroke="currentcolor"/><path d="M24 0V64" fill="none" stroke="currentcolor"/><path d="M24 416v64" fill="none" stroke="currentcolor"/><path d="M24 528v64" fill="none" stroke="currentcolor"/><path d="M64 480v32" fill="none" stroke="currentcolor"/><path d="M112 336v64" fill="none" stroke="currentcolor"/><path d="M160 592v64" fill="none" stroke="currentcolor"/><path d="M272 64V208" fill="none" stroke="currentcolor"/><path d="M296 0V16" fill="none" stroke="currentcolor"/><path d="M296 16V64" fill="none" stroke="currentcolor"/><path d="M296 416v64" fill="none" stroke="currentcolor"/><path d="M296 528v64" fill="none" stroke="currentcolor"/><path d="M312 624v64" fill="none" stroke="currentcolor"/><path d="M336 0V48" fill="none" stroke="currentcolor"/><path d="M336 48V64" fill="none" stroke="currentcolor"/><path d="M336 192v64" fill="none" stroke="currentcolor"/><path d="M336 304v32" fill="none" stroke="currentcolor"/><path d="M336 336v32" fill="none" stroke="currentcolor"/><path d="M368 64V176" fill="none" stroke="currentcolor"/><path d="M424 368V608" fill="none" stroke="currentcolor"/><path d="M432 256v32" fill="none" stroke="currentcolor"/><path d="M528 624v64" fill="none" stroke="currentcolor"/><path d="M576 192v64" fill="none" stroke="currentcolor"/><path d="M584 0V64" fill="none" stroke="currentcolor"/><path d="M584 304v64" fill="none" stroke="currentcolor"/><path d="M64 512v8" fill="none" stroke="currentcolor"/><polygon points="80.000000,512.000000 68.000000,506.399994 68.000000,517.599976" fill="currentcolor" transform="rotate(90.000000, 64.000000, 512.000000)"/><path d="M112 4e2v8" fill="none" stroke="currentcolor"/><polygon points="128.000000,400.000000 116.000000,394.399994 116.000000,405.600006" fill="currentcolor" transform="rotate(90.000000, 112.000000, 400.000000)"/><polygon points="312.000000,48.000000 300.000000,42.400002 300.000000,53.599998" fill="currentcolor" transform="rotate(180.000000, 304.000000, 48.000000)"/><polygon points="312.000000,656.000000 300.000000,650.400024 300.000000,661.599976" fill="currentcolor" transform="rotate(0.000000, 304.000000, 656.000000)"/><polygon points="336.000000,16.000000 324.000000,10.400000 324.000000,21.600000" fill="currentcolor" transform="rotate(0.000000, 328.000000, 16.000000)"/><polygon points="336.000000,208.000000 324.000000,202.399994 324.000000,213.600006" fill="currentcolor" transform="rotate(0.000000, 328.000000, 208.000000)"/><path d="M368 176v8" fill="none" stroke="currentcolor"/><polygon points="384.000000,176.000000 372.000000,170.399994 372.000000,181.600006" fill="currentcolor" transform="rotate(90.000000, 368.000000, 176.000000)"/><path d="M424 608v8" fill="none" stroke="currentcolor"/><polygon points="440.000000,608.000000 428.000000,602.400024 428.000000,613.599976" fill="currentcolor" transform="rotate(90.000000, 424.000000, 608.000000)"/><path d="M432 288v8" fill="none" stroke="currentcolor"/><polygon points="448.000000,288.000000 436.000000,282.399994 436.000000,293.600006" fill="currentcolor" transform="rotate(90.000000, 432.000000, 288.000000)"/><text text-anchor="middle" x="0" y="100" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="0" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="0" y="132" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="8" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="8" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="8" y="132" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="16" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="16" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="16" y="132" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="24" y="100" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="24" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="32" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="32" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="32" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="40" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="40" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="40" y="132" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="48" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="48" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="48" y="452" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="56" y="100" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="56" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="56" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="56" y="452" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="64" y="100" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="64" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="64" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="452" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="72" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="72" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="72" y="452" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="72" y="468" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="80" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="80" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="80" y="452" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="80" y="468" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="80" y="500" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="80" y="516" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="80" y="564" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="88" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="88" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="88" y="452" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="88" y="468" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="88" y="500" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="88" y="516" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="88" y="564" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="96" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="96" y="452" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="96" y="468" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="96" y="500" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="96" y="516" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="96" y="564" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="104" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="104" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="104" y="148" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="104" y="164" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="104" y="452" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="104" y="468" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="104" y="500" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="104" y="516" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="104" y="564" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="112" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="112" y="148" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="112" y="452" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="112" y="468" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="112" y="500" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="112" y="516" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="564" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="120" y="100" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="120" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="120" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="120" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="120" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="120" y="452" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="120" y="468" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="120" y="500" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="516" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="120" y="564" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="36" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="128" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="128" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="128" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="128" y="148" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="128" y="164" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="128" y="356" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="128" y="372" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="128" y="388" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="128" y="404" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="128" y="452" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="128" y="468" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="128" y="516" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="128" y="564" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="136" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="136" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="136" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="136" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="356" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="136" y="372" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="388" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="404" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="136" y="452" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="136" y="468" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="136" y="500" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="136" y="564" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="144" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="144" y="100" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="144" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="144" y="148" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="144" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="144" y="372" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="144" y="388" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="144" y="404" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="144" y="452" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="144" y="500" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="144" y="516" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="564" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="152" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="152" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="152" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="152" y="132" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="152" y="164" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="152" y="356" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="152" y="372" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="152" y="388" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="152" y="404" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="152" y="452" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="152" y="468" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="152" y="500" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="152" y="516" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="152" y="564" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="160" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="160" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="160" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="160" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="160" y="148" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="160" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="160" y="356" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="160" y="372" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="160" y="388" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="160" y="404" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="160" y="452" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="160" y="468" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="160" y="516" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="160" y="564" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="168" y="36" fill="currentcolor" style="font-size:1em">H</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="168" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="168" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="168" y="148" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="168" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="168" y="356" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="168" y="372" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="168" y="388" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="168" y="404" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="168" y="452" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="168" y="468" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="168" y="500" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="168" y="516" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="168" y="564" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="176" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="176" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="176" y="132" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="176" y="148" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="176" y="164" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="176" y="356" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="176" y="372" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="176" y="388" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="176" y="404" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="176" y="452" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="176" y="468" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="176" y="500" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="176" y="516" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="176" y="564" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="176" y="612" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="184" y="100" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="184" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="184" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="184" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="184" y="372" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="184" y="452" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="184" y="468" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="184" y="500" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="184" y="516" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="184" y="564" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="184" y="612" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="192" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="192" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="192" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="192" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="192" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="192" y="356" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="192" y="372" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="388" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="192" y="404" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="192" y="452" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="192" y="468" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="192" y="500" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="192" y="516" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="192" y="564" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="192" y="612" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="200" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="200" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="200" y="132" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="200" y="148" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="200" y="356" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="200" y="388" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="200" y="404" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="200" y="452" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="200" y="500" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="200" y="516" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="200" y="564" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="200" y="612" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="208" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="208" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="208" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="208" y="164" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="208" y="356" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="208" y="372" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="208" y="404" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="452" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="208" y="468" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="208" y="500" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="208" y="564" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="208" y="612" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="216" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="216" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="216" y="164" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="216" y="356" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="216" y="372" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="216" y="388" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="216" y="404" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="216" y="452" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="216" y="468" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="216" y="516" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="216" y="564" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="216" y="612" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="224" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="224" y="132" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="224" y="148" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="224" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="224" y="356" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="224" y="372" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="224" y="388" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="224" y="404" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="224" y="452" fill="currentcolor" style="font-size:1em">F</text><text text-anchor="middle" x="224" y="468" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="224" y="500" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="224" y="516" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="224" y="564" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="232" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="232" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="232" y="148" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="232" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="232" y="356" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="232" y="388" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="404" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="232" y="452" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="232" y="468" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="232" y="500" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="232" y="564" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="612" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="240" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="240" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="240" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="240" y="356" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="240" y="372" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="240" y="388" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="240" y="404" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="240" y="452" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="240" y="516" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="240" y="564" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="240" y="612" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="248" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="248" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="148" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="248" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="356" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="248" y="372" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="248" y="404" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="248" y="452" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="248" y="500" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="248" y="516" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="564" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="612" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="256" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="256" y="164" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="256" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="372" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="256" y="388" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="256" y="404" fill="currentcolor" style="font-size:1em">"</text><text text-anchor="middle" x="256" y="452" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="256" y="500" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="256" y="516" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="256" y="612" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="264" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="264" y="356" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="264" y="372" fill="currentcolor" style="font-size:1em">/</text><text text-anchor="middle" x="264" y="388" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="264" y="452" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="264" y="500" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="264" y="516" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="272" y="372" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="272" y="388" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="272" y="452" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="272" y="500" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="272" y="516" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="280" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="280" y="356" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="280" y="372" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="280" y="388" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="280" y="500" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="288" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="288" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="288" y="500" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="288" y="516" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="296" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="296" y="356" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="296" y="516" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="304" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="304" y="356" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="304" y="500" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="304" y="516" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="312" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="312" y="356" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="312" y="500" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="312" y="516" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="320" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="320" y="516" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="328" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="328" y="500" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="328" y="516" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="336" y="500" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="336" y="516" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="344" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="344" y="500" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="344" y="516" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="352" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="352" y="500" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="360" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="360" y="228" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="368" y="228" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="376" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="376" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="376" y="244" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="384" y="100" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="384" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="384" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="384" y="148" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="384" y="228" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="384" y="244" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="384" y="660" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="392" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="392" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="392" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="392" y="228" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="392" y="244" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="392" y="340" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="392" y="660" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="400" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="400" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="400" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="400" y="148" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="400" y="228" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="400" y="244" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="400" y="340" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="400" y="660" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="408" y="100" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="408" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="408" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="408" y="148" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="408" y="228" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="408" y="244" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="408" y="340" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="408" y="660" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="416" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="416" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="416" y="132" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="416" y="148" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="416" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="416" y="244" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="416" y="340" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="416" y="660" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="424" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="424" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="424" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="424" y="228" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="424" y="244" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="424" y="340" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="424" y="660" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="432" y="36" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="432" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="432" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="432" y="132" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="432" y="148" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="432" y="228" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="432" y="244" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="432" y="340" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="432" y="660" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="440" y="36" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="440" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="440" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="440" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="440" y="148" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="440" y="228" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="440" y="244" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="440" y="340" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="440" y="596" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="440" y="660" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="448" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="448" y="100" fill="currentcolor" style="font-size:1em">`</text><text text-anchor="middle" x="448" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="448" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="448" y="228" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="448" y="276" fill="currentcolor" style="font-size:1em">…</text><text text-anchor="middle" x="448" y="292" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="448" y="340" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="448" y="596" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="448" y="660" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="456" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="456" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="456" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="456" y="148" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="456" y="228" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="456" y="244" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="456" y="292" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="456" y="340" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="456" y="596" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="456" y="660" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="464" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="464" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="464" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="464" y="148" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="464" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="464" y="244" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="464" y="276" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="464" y="292" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="464" y="340" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="464" y="596" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="464" y="660" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="472" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="472" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="472" y="132" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="472" y="228" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="472" y="244" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="472" y="276" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="472" y="292" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="472" y="340" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="480" y="36" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="480" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="480" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="480" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="480" y="244" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="480" y="276" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="480" y="292" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="480" y="340" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="488" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="488" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="488" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="488" y="228" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="488" y="244" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="488" y="340" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="496" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="496" y="132" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="496" y="228" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="496" y="244" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="496" y="276" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="496" y="292" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="496" y="340" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="504" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="504" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="504" y="228" fill="currentcolor" style="font-size:1em">F</text><text text-anchor="middle" x="504" y="244" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="504" y="276" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="504" y="292" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="504" y="340" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="512" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="512" y="132" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="512" y="228" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="512" y="276" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="512" y="340" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="520" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="520" y="132" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="520" y="228" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="520" y="244" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="520" y="276" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="520" y="292" fill="currentcolor" style="font-size:1em">…</text><text text-anchor="middle" x="520" y="340" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="528" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="528" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="528" y="228" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="528" y="244" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="528" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="528" y="340" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="536" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="536" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="536" y="228" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="536" y="244" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="536" y="276" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="544" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="544" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="544" y="228" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="544" y="244" fill="currentcolor" style="font-size:1em">…</text><text text-anchor="middle" x="552" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="552" y="228" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="552" y="276" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="560" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="560" y="132" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="560" y="276" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="568" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="568" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="568" y="276" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="576" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="576" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="576" y="276" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="584" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="584" y="132" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="584" y="276" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="592" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="600" y="116" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="608" y="116" fill="currentcolor" style="font-size:1em">·</text></g></svg></div></div></center><p>With this new setup, if Python finalizes (&ldquo;calls <code>__del__</code> on&rdquo;) the <code>_Context</code>
<em>before</em> a <code>_ValueHandle</code> that belonged to that context, aka &ldquo;the wrong order&rdquo;,
what happens now is:</p><ol><li><p><code>_Context.__del__</code> calls <code>MiniRacer::ContextFactory</code> to destroy its
<code>MiniRacer::Context</code>. <code>MiniRacer::Context</code> destroys the
<code>MiniRacer::BinaryValueFactory</code>, which in turn notices some C++
<code>MiniRacer::BinaryValue</code> objects were left alive (before this change, the
<code>BinaryValueFactory</code> wasn&rsquo;t tracking them and thus didn&rsquo;t even know they
still existed). <code>BinaryValueFactory</code> goes ahead and tears all those leftover
<code>BinaryValue</code> objects down. This avoids a memory leak, and avoids dangling
pointers on the C++ side.</p></li><li><p>When Python later calls <code>_ValueHandle.__del__</code>, it passes both a context ID
<em>and</em> the value handle to <code>MiniRacer::ContextFactory</code>.
<code>MiniRacer::ContextFactory</code> notices that the whole context ID is no longer
valid because the context was torn down already. The context and its values
are already gone. Thus, this call can be safely ignored.</p></li></ol><p>I think the design strategy is generalizable to most Python/C++ integrations,
and potentially likewise Java/C++ and C#/C++ integrations. (<em>TL;DR: use integer
identifiers instead of passing pointers, track object lifecycle in maps on the
C++ side, validate all incoming identifiers from Python, and refactor so that
out-of-order finalization doesn&rsquo;t hurt anything</em>). I wonder if it&rsquo;s written down
anywhere.</p><h2 id=contribute>Contribute!
<a href=#contribute><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>That wraps up this overly detailed changelog for now!</p><p>If you&rsquo;re reading this and want to contribute, go for it! See
<a href=https://bpcreech.com/PyMiniRacer/contributing/>the contribution guide</a>.</p><p>One thing I wish PyMiniRacer really had, and don&rsquo;t have time to build right now,
is extension via user-supplied Python callback functions. A more detailed
descrition and implementation ideas can be found
<a href=https://github.com/bpcreech/PyMiniRacer/issues/39>here</a>.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/javascript/ rel=tag>javascript</a></li><li class=tags__item><a class="tags__link btn" href=/tags/typescript/ rel=tag>typescript</a></li><li class=tags__item><a class="tags__link btn" href=/tags/python/ rel=tag>python</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Ben Creech avatar" src=/img/maine_cropped.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Ben Creech</span></div><div class=authorbox__description>Ben Creech is definitely a real person and insisting on this fact is not at all suspicious.</div></div><section class=comments><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bpcreech.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2024 Ben Creech.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>