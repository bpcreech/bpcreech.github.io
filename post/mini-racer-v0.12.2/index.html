<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>PyMiniRacer v0.12.2 - Disparate Treasures</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="PyMiniRacer v0.12.2"><meta property="og:description" content="The dynamic language embedding
turducken is complete: you can now
call Python from JavaScript from Python!
By writing logic in Python and exposing it to V8&rsquo;s JavaScript sandbox, you can
now in theory, while writing only Python and JavaScript, create your own JS
extension library similar to
NodeJS&rsquo;s standard library.Obviously,
anything created this way this will almost certainly be less extensive, less
standardized, and less efficient than the NodeJS standard library; but it will
be more tailored to your use case.
This post follows up on prior content related to
reviving PyMiniRacer and then
giving Python code the power to directly poke JS Objects, call JS Functions, and await JS Promises."><meta property="og:type" content="article"><meta property="og:url" content="https://bpcreech.com/post/mini-racer-v0.12.2/"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-05-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-24T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PyMiniRacer v0.12.2"><meta name=twitter:description content="The dynamic language embedding
turducken is complete: you can now
call Python from JavaScript from Python!
By writing logic in Python and exposing it to V8&rsquo;s JavaScript sandbox, you can
now in theory, while writing only Python and JavaScript, create your own JS
extension library similar to
NodeJS&rsquo;s standard library.Obviously,
anything created this way this will almost certainly be less extensive, less
standardized, and less efficient than the NodeJS standard library; but it will
be more tailored to your use case.
This post follows up on prior content related to
reviving PyMiniRacer and then
giving Python code the power to directly poke JS Objects, call JS Functions, and await JS Promises."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title="Disparate Treasures" rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/squirrel.png></div><div class="logo__item logo__text"><div class=logo__title>Disparate Treasures</div><div class=logo__tagline>Ben Creech's arbitrary stuff</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>PyMiniRacer v0.12.2</h1><p class=post__lead>Call your Python from your JavaScript from your Python</p></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#adding-python-extensions-to-v8-without-writing-any-c-code>Adding Python extensions to V8 without writing any C++ code</a><ul><li><a href=#security-note>Security note</a></li><li><a href=#about-async>About <code>async</code></a></li></ul></li><li><a href=#internal-changes-to-pyminiracer>Internal changes to PyMiniRacer</a><ul><li><a href=#implementing-wrap_py_function>Implementing <code>wrap_py_function</code></a></li><li><a href=#un-shared_ptr-all-the-things>Un-<code>shared_ptr</code> all the things</a></li><li><a href=#breaking-up-the-python-code>Breaking up the Python code</a></li></ul></li></ul></nav></div></div><div class="content post__content clearfix"><p>The dynamic language embedding
<a href=https://en.wikipedia.org/wiki/Turducken>turducken</a> is complete: you can now
call Python from JavaScript from Python!</p><p>By writing logic in Python and exposing it to V8&rsquo;s JavaScript sandbox, you can
now in theory, while writing <em>only Python and JavaScript</em>, create your own JS
extension library similar to
<a href=https://nodejs.org/docs/latest/api/>NodeJS&rsquo;s standard library</a>.Obviously,
anything created this way this will almost certainly be less extensive, less
standardized, and less efficient than the NodeJS standard library; but it will
be <em>more tailored to your use case</em>.</p><p>This post follows up on prior content related to
<a href=https://github.com/bpcreech/PyMiniRacer>reviving PyMiniRacer</a> and then
<a href=https://bpcreech.com/post/mini-racer-v0.11.1/>giving Python code the power to directly poke JS Objects, call JS Functions, and await JS Promises</a>.</p><h2 id=adding-python-extensions-to-v8-without-writing-any-c-code>Adding Python extensions to V8 without writing any C++ code
<a href=#adding-python-extensions-to-v8-without-writing-any-c-code><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>PyMiniRacer runs a pretty vanilla V8 sandbox, and thus it doesn&rsquo;t have any
<a href=https://developer.mozilla.org/en-US/docs/Web/API>Web APIs</a>,
<a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API>Web Workers APIs</a>,
or any of <a href=https://nodejs.org/docs/latest/api/>the NodeJS SDK</a>. This provides,
by default, both simplicity and
<a href=https://bpcreech.com/PyMiniRacer/architecture/#security-goals>security</a>.</p><p>Thus, until now, you couldn&rsquo;t, say, go and grab a random URL off the Internet,
or even log to stdout (e.g., using <code>console.log</code>). Neither is bundled with V8.</p><p>Well, now you can extend PyMiniRacer to add that functionality yourself!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> aiohttp
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> py_mini_racer <span style=color:#f92672>import</span> MiniRacer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mr <span style=color:#f92672>=</span> MiniRacer()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>demo</span>():
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>log</span>(content):
</span></span><span style=display:flex><span>    print(content)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>antigravity</span>():
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> antigravity
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> aiohttp<span style=color:#f92672>.</span>ClientSession() <span style=color:#66d9ef>as</span> session:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_url</span>(url):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> session<span style=color:#f92672>.</span>get(url) <span style=color:#66d9ef>as</span> resp:
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> resp<span style=color:#f92672>.</span>text()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> (
</span></span><span style=display:flex><span>         mr<span style=color:#f92672>.</span>wrap_py_function(log) <span style=color:#66d9ef>as</span> log_js,
</span></span><span style=display:flex><span>         mr<span style=color:#f92672>.</span>wrap_py_function(get_url) <span style=color:#66d9ef>as</span> get_url_js,
</span></span><span style=display:flex><span>         mr<span style=color:#f92672>.</span>wrap_py_function(antigravity) <span style=color:#66d9ef>as</span> antigravity_js,
</span></span><span style=display:flex><span>      ):
</span></span><span style=display:flex><span>      <span style=color:#75715e># Add a basic log-to-stdout capability to JavaScript:</span>
</span></span><span style=display:flex><span>      mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;this&#39;</span>)[<span style=color:#e6db74>&#39;log&#39;</span>] <span style=color:#f92672>=</span> log_js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Add a basic url fetch capability to JavaScript:</span>
</span></span><span style=display:flex><span>      mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;this&#39;</span>)[<span style=color:#e6db74>&#39;get_url&#39;</span>] <span style=color:#f92672>=</span> get_url_js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Add antigravity:</span>
</span></span><span style=display:flex><span>      mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;this&#39;</span>)[<span style=color:#e6db74>&#39;antigravity&#39;</span>] <span style=color:#f92672>=</span> antigravity_js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async () =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   const content = await get_url(&#34;https://xkcd.com/353/&#34;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   await log(content);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   await antigravity();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># prints the contents of https://xkcd.com/353/ to stdout... and then also loads it in</span>
</span></span><span style=display:flex><span><span style=color:#75715e># your browser:</span>
</span></span><span style=display:flex><span>asyncio<span style=color:#f92672>.</span>run(demo())
</span></span></code></pre></div><h3 id=security-note>Security note
<a href=#security-note><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>It is possible (<em>modulo open-source disclaimers of warranty, etc</em>) to use
PyMiniRacer to run untrusted JS code; this is a
<a href=https://bpcreech.com/PyMiniRacer/architecture/#security-goals>stated security goal</a>.</p><p>However, exposing your Python functions to JavaScript of course breaches the
hermetic V8 sandbox. If you extend PyMiniRacer by exposing Python functions, you
are obviously taking security matters into your own hands. The above demo, by
exposing an arbitrary <code>get_url</code> function, would expose an obvious data
exfiltration and denial-of-service vector if we were running untrusted JS code
with it.</p><h3 id=about-async>About <code>async</code>
<a href=#about-async><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>You will note that the above demo is using <code>async</code> heavily, both on the Python
and JavaScript side. PyMiniRacer only lets you expose <code>async</code> Python functions
to V8. These are represented as <code>async</code> on the JavaScript side, meaning you need
to <code>await</code> them, meaning in turn that the easiest way to even call them is from
<code>async</code> JavaScript code. Everything gets
<a href=https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/>red</a>
very fast!</p><p>It turns out this is the only way to reliably expose Python functionality to V8.
V8 runs JavaScript in a single-threaded fashion, and doing anything synchronous
in a callback to Python would block the entire V8 isolate. Worse, things would
likely deadlock very quicklyâ€”if your Python extension function tries to call
back into V8 it will freeze. The only thing we can reasonably do, when
JavaScript calls outside the V8 sandbox, is create a <code>Promise</code> and do the work
to fulfill that <code>Promise</code> out of band.</p><h2 id=internal-changes-to-pyminiracer>Internal changes to PyMiniRacer
<a href=#internal-changes-to-pyminiracer><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><h3 id=implementing-wrap_py_function>Implementing <code>wrap_py_function</code>
<a href=#implementing-wrap_py_function><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>I put some general design ideas about <code>wrap_py_function</code>
<a href=https://github.com/bpcreech/PyMiniRacer/issues/39>here</a>. What landed in
PyMiniRacer is basically
<a href=https://github.com/bpcreech/PyMiniRacer/issues/39#issuecomment-2043984826>&ldquo;Alternate implementation idea 3&rdquo;</a>.
Generally speaking:</p><h4 id=generalizing-pyminiracer-callbacks>Generalizing PyMiniRacer callbacks
<a href=#generalizing-pyminiracer-callbacks><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h4><p>PyMiniRacer already had a C++-to-Python callback mechanism; this was used to
await <code>Promise</code> objects. We just had to generalize it!</p><p>&mldr; Which specifically means allowing V8 to <em>reuse</em> a callback. With <code>Promises</code>,
callbacks are only used 0.5 times on average (either the <code>resolve</code> or <code>reject</code>
is used exactly once). PyMiniRacer handled cleanup of these on its own; the
first time either <code>resolve</code> or <code>reject</code> was called, PyMiniRacer could destroy
both callbacks.</p><p>But now we want to expose arbitary-use callbacks, which need to live longer&mldr;
We just need to attach a tiny bit of C++ state (the Python address of the
callback function, and a pointer to our V8 value wrapper) to a callback object,
and hand that off to V8.</p><p>Unfortunately,
<a href=https://stackoverflow.com/questions/24107280/v8-weakcallback-never-gets-called>V8 isn&rsquo;t very good at telling us when it&rsquo;s <em>done with</em> an extension object we give it</a>.
I couldn&rsquo;t make it work at all, and all commentary I can find on the matter says
trying to get V8 <code>MakeWeak</code> and finalizers work reliably is a fool&rsquo;s errand.
This creates a memory management conundrum: we need to create a small bit of
per-callback C++ state and hand it to V8, but V8 won&rsquo;t reliably tell us when all
the references to that state are gone.</p><p>So I moved to a model of creating <em>one such callback object per MiniRacer
context</em>. We can tear <em>that</em> object down when tearing down the whole MiniRacer
context, rather than relying on V8 to tell us when it&rsquo;s done with the data we
gave it. In order to multiplex many callbacks into that object, we can just give
JavaScript an ID number (because V8 <em>does</em> manage to reliably destruct
numbers!). This new logic lives in
<a href=https://github.com/bpcreech/PyMiniRacer/blob/release/v0.12.2/src/v8_py_frontend/js_callback_maker.h><code>MiniRacer::JSCallbackMaker</code></a>.</p><p>Meanwhile the Python side of things can manage its own map of ID number to
callback, and remove entries from that map when it wants to. (This is what the
<code>wrap_py_function</code> context manager does on <code>__exit__</code>). Since Python is tearing
down the callback and its ID on its own schedule, in total ignorance of
JavaScript&rsquo;s references to that callback ID, it&rsquo;s possible for JS to keep trying
to call Python after it tore down the callback. This is working as designed;
such calls are ignored.</p><h4 id=system-diagram>System diagram
<a href=#system-diagram><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h4><p>Here&rsquo;s roughly what the system looks like:</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 616 1097"><g transform="translate(8,16)"><path d="M0 0H328" fill="none" stroke="currentcolor"/><path d="M128 64H312" fill="none" stroke="currentcolor"/><path d="M128 128H232" fill="none" stroke="currentcolor"/><path d="M232 128h80" fill="none" stroke="currentcolor"/><path d="M0 160H224" fill="none" stroke="currentcolor"/><path d="M240 160h16" fill="none" stroke="currentcolor"/><path d="M272 160h56" fill="none" stroke="currentcolor"/><path d="M0 208H224" fill="none" stroke="currentcolor"/><path d="M240 208h16" fill="none" stroke="currentcolor"/><path d="M272 208h56" fill="none" stroke="currentcolor"/><path d="M16 272H224" fill="none" stroke="currentcolor"/><path d="M240 272h16" fill="none" stroke="currentcolor"/><path d="M272 272h40" fill="none" stroke="currentcolor"/><path d="M32 336H264" fill="none" stroke="currentcolor"/><path d="M264 336h32" fill="none" stroke="currentcolor"/><path d="M32 4e2H232" fill="none" stroke="currentcolor"/><path d="M232 4e2h64" fill="none" stroke="currentcolor"/><path d="M16 432H144" fill="none" stroke="currentcolor"/><path d="M144 432h80" fill="none" stroke="currentcolor"/><path d="M240 432h16" fill="none" stroke="currentcolor"/><path d="M272 432h40" fill="none" stroke="currentcolor"/><path d="M0 464H136" fill="none" stroke="currentcolor"/><path d="M152 464h72" fill="none" stroke="currentcolor"/><path d="M240 464h16" fill="none" stroke="currentcolor"/><path d="M272 464h56" fill="none" stroke="currentcolor"/><path d="M0 512H224" fill="none" stroke="currentcolor"/><path d="M240 512h16" fill="none" stroke="currentcolor"/><path d="M272 512H6e2" fill="none" stroke="currentcolor"/><path d="M16 576H256" fill="none" stroke="currentcolor"/><path d="M272 576h24" fill="none" stroke="currentcolor"/><path d="M328 576H584" fill="none" stroke="currentcolor"/><path d="M296 608h64" fill="none" stroke="currentcolor"/><path d="M32 640H264" fill="none" stroke="currentcolor"/><path d="M264 640h16" fill="none" stroke="currentcolor"/><path d="M344 640H568" fill="none" stroke="currentcolor"/><path d="M32 720H280" fill="none" stroke="currentcolor"/><path d="M16 752H256" fill="none" stroke="currentcolor"/><path d="M272 752h24" fill="none" stroke="currentcolor"/><path d="M368 752H552" fill="none" stroke="currentcolor"/><path d="M72 784H264" fill="none" stroke="currentcolor"/><path d="M264 784h32" fill="none" stroke="currentcolor"/><path d="M304 816h40" fill="none" stroke="currentcolor"/><path d="M368 864H552" fill="none" stroke="currentcolor"/><path d="M72 896H296" fill="none" stroke="currentcolor"/><path d="M344 896H568" fill="none" stroke="currentcolor"/><path d="M344 944H448" fill="none" stroke="currentcolor"/><path d="M448 944H568" fill="none" stroke="currentcolor"/><path d="M344 1008H568" fill="none" stroke="currentcolor"/><path d="M328 1040H584" fill="none" stroke="currentcolor"/><path d="M0 1072H6e2" fill="none" stroke="currentcolor"/><path d="M0 0V160" fill="none" stroke="currentcolor"/><path d="M0 208V464" fill="none" stroke="currentcolor"/><path d="M0 512v560" fill="none" stroke="currentcolor"/><path d="M16 272V432" fill="none" stroke="currentcolor"/><path d="M16 576V752" fill="none" stroke="currentcolor"/><path d="M32 336v64" fill="none" stroke="currentcolor"/><path d="M32 640v80" fill="none" stroke="currentcolor"/><path d="M72 784V896" fill="none" stroke="currentcolor"/><path d="M128 64v64" fill="none" stroke="currentcolor"/><path d="M144 432v64" fill="none" stroke="currentcolor"/><path d="M232 128V320" fill="none" stroke="currentcolor"/><path d="M232 4e2V560" fill="none" stroke="currentcolor"/><path d="M264 144V336" fill="none" stroke="currentcolor"/><path d="M264 416V640" fill="none" stroke="currentcolor"/><path d="M264 736v48" fill="none" stroke="currentcolor"/><path d="M280 640v80" fill="none" stroke="currentcolor"/><path d="M296 336v64" fill="none" stroke="currentcolor"/><path d="M296 576v32" fill="none" stroke="currentcolor"/><path d="M296 608V752" fill="none" stroke="currentcolor"/><path d="M296 784V896" fill="none" stroke="currentcolor"/><path d="M312 64v64" fill="none" stroke="currentcolor"/><path d="M312 272V432" fill="none" stroke="currentcolor"/><path d="M328 0V160" fill="none" stroke="currentcolor"/><path d="M328 208V464" fill="none" stroke="currentcolor"/><path d="M328 576v16" fill="none" stroke="currentcolor"/><path d="M328 624V8e2" fill="none" stroke="currentcolor"/><path d="M328 832v208" fill="none" stroke="currentcolor"/><path d="M344 640V816" fill="none" stroke="currentcolor"/><path d="M344 816v80" fill="none" stroke="currentcolor"/><path d="M344 944v64" fill="none" stroke="currentcolor"/><path d="M368 752V864" fill="none" stroke="currentcolor"/><path d="M448 912v32" fill="none" stroke="currentcolor"/><path d="M552 752V864" fill="none" stroke="currentcolor"/><path d="M568 640V896" fill="none" stroke="currentcolor"/><path d="M568 944v64" fill="none" stroke="currentcolor"/><path d="M584 576v464" fill="none" stroke="currentcolor"/><path d="M6e2 512v560" fill="none" stroke="currentcolor"/><path d="M328 592v8" fill="none" stroke="currentcolor"/><path d="M328 616v8" fill="none" stroke="currentcolor"/><path d="M328 8e2v8" fill="none" stroke="currentcolor"/><path d="M328 824v8" fill="none" stroke="currentcolor"/><path d="M136 192v8" fill="none" stroke="currentcolor"/><polygon points="152.000000,192.000000 140.000000,186.399994 140.000000,197.600006" fill="currentcolor" transform="rotate(90.000000, 136.000000, 192.000000)"/><path d="M144 496v8" fill="none" stroke="currentcolor"/><polygon points="160.000000,496.000000 148.000000,490.399994 148.000000,501.600006" fill="currentcolor" transform="rotate(90.000000, 144.000000, 496.000000)"/><path d="M232 320v8" fill="none" stroke="currentcolor"/><polygon points="248.000000,320.000000 236.000000,314.399994 236.000000,325.600006" fill="currentcolor" transform="rotate(90.000000, 232.000000, 320.000000)"/><path d="M232 560v8" fill="none" stroke="currentcolor"/><polygon points="248.000000,560.000000 236.000000,554.400024 236.000000,565.599976" fill="currentcolor" transform="rotate(90.000000, 232.000000, 560.000000)"/><path d="M264 136v8" fill="none" stroke="currentcolor"/><polygon points="280.000000,144.000000 268.000000,138.399994 268.000000,149.600006" fill="currentcolor" transform="rotate(270.000000, 264.000000, 144.000000)"/><path d="M264 408v8" fill="none" stroke="currentcolor"/><polygon points="280.000000,416.000000 268.000000,410.399994 268.000000,421.600006" fill="currentcolor" transform="rotate(270.000000, 264.000000, 416.000000)"/><path d="M264 728v8" fill="none" stroke="currentcolor"/><polygon points="280.000000,736.000000 268.000000,730.400024 268.000000,741.599976" fill="currentcolor" transform="rotate(270.000000, 264.000000, 736.000000)"/><polygon points="312.000000,816.000000 300.000000,810.400024 300.000000,821.599976" fill="currentcolor" transform="rotate(180.000000, 304.000000, 816.000000)"/><path d="M360 624v8" fill="none" stroke="currentcolor"/><polygon points="376.000000,624.000000 364.000000,618.400024 364.000000,629.599976" fill="currentcolor" transform="rotate(90.000000, 360.000000, 624.000000)"/><path d="M448 904v8" fill="none" stroke="currentcolor"/><polygon points="464.000000,912.000000 452.000000,906.400024 452.000000,917.599976" fill="currentcolor" transform="rotate(270.000000, 448.000000, 912.000000)"/><text text-anchor="middle" x="16" y="532" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="24" y="532" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="32" y="532" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="32" y="612" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="40" y="532" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="40" y="612" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="48" y="532" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="48" y="612" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="56" y="612" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="56" y="692" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="64" y="532" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="64" y="612" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="64" y="692" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="72" y="244" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="72" y="532" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="72" y="628" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="72" y="692" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="80" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="80" y="244" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="80" y="532" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="80" y="612" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="80" y="628" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="80" y="692" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="88" y="244" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="88" y="308" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="88" y="372" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="88" y="532" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="88" y="612" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="88" y="628" fill="currentcolor" style="font-size:1em">J</text><text text-anchor="middle" x="88" y="692" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="96" y="244" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="96" y="308" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="96" y="372" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="96" y="532" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="96" y="612" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="628" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="96" y="692" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="104" y="244" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="104" y="308" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="104" y="372" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="104" y="532" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="104" y="612" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="104" y="628" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="104" y="692" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="112" y="244" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="308" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="112" y="372" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="532" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="112" y="612" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="112" y="628" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="112" y="692" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="180" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="120" y="244" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="308" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="120" y="372" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="120" y="532" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="612" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="120" y="628" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="120" y="692" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="128" y="36" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="128" y="244" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="128" y="308" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="128" y="372" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="128" y="452" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="128" y="532" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="128" y="612" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="128" y="628" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="128" y="692" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="128" y="836" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="128" y="852" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="128" y="868" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="136" y="180" fill="currentcolor" style="font-size:1em">|</text><text text-anchor="middle" x="136" y="308" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="136" y="372" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="136" y="532" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="136" y="612" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="628" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="136" y="676" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="136" y="692" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="136" y="836" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="136" y="852" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="136" y="868" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="144" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="144" y="244" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="144" y="308" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="144" y="372" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="144" y="532" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="144" y="612" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="144" y="628" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="144" y="676" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="144" y="692" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="144" y="836" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="144" y="852" fill="currentcolor" style="font-size:1em">J</text><text text-anchor="middle" x="144" y="868" fill="currentcolor" style="font-size:1em">O</text><text text-anchor="middle" x="152" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="152" y="244" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="152" y="372" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="152" y="532" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="152" y="628" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="152" y="676" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="152" y="692" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="152" y="836" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="152" y="852" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="152" y="868" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="160" y="36" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="160" y="100" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="160" y="244" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="160" y="308" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="160" y="372" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="160" y="532" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="160" y="628" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="160" y="676" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="160" y="692" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="160" y="836" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="160" y="852" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="160" y="868" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="168" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="168" y="244" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="168" y="308" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="168" y="372" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="168" y="532" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="168" y="628" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="168" y="676" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="168" y="692" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="168" y="820" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="168" y="836" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="168" y="852" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="168" y="868" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="176" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="176" y="244" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="176" y="308" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="176" y="372" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="176" y="532" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="176" y="628" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="176" y="692" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="176" y="820" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="176" y="836" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="176" y="852" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="176" y="868" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="184" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="184" y="244" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="308" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="184" y="372" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="184" y="532" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="184" y="628" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="184" y="692" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="820" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="184" y="836" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="184" y="852" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="184" y="868" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="192" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="192" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="192" y="244" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="192" y="308" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="192" y="372" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="532" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="192" y="628" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="192" y="692" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="192" y="820" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="192" y="836" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="192" y="852" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="192" y="868" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="200" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="200" y="244" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="200" y="308" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="200" y="372" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="200" y="532" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="200" y="628" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="200" y="692" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="200" y="820" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="200" y="852" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="200" y="868" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="208" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="208" y="244" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="208" y="308" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="208" y="372" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="208" y="692" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="208" y="852" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="208" y="868" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="216" y="100" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="216" y="148" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="216" y="308" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="216" y="372" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="216" y="420" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="216" y="692" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="216" y="852" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="216" y="868" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="224" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="692" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="224" y="852" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="224" y="868" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="232" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="232" y="692" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="852" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="232" y="868" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="240" y="100" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="240" y="692" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="240" y="852" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="240" y="868" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="248" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="248" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="248" y="628" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="248" y="692" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="248" y="852" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="868" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="256" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="256" y="100" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="256" y="852" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="264" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="264" y="100" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="272" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="272" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="280" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="280" y="324" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="280" y="772" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="288" y="324" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="312" y="836" fill="currentcolor" style="font-size:1em">7</text><text text-anchor="middle" x="352" y="596" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="384" y="820" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="392" y="612" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="392" y="820" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="392" y="836" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="400" y="612" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="400" y="820" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="400" y="836" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="400" y="980" fill="currentcolor" style="font-size:1em">J</text><text text-anchor="middle" x="408" y="612" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="408" y="820" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="408" y="836" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="408" y="980" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="416" y="612" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="416" y="676" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="416" y="804" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="416" y="820" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="416" y="836" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="416" y="980" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="424" y="612" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="424" y="676" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="424" y="804" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="424" y="820" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="424" y="836" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="424" y="980" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="432" y="676" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="432" y="804" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="432" y="820" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="432" y="836" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="432" y="980" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="440" y="612" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="440" y="676" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="440" y="788" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="440" y="804" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="440" y="820" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="440" y="836" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="440" y="980" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="448" y="612" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="448" y="676" fill="currentcolor" style="font-size:1em">F</text><text text-anchor="middle" x="448" y="788" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="448" y="804" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="448" y="820" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="448" y="836" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="448" y="980" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="456" y="612" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="456" y="676" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="456" y="788" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="456" y="804" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="456" y="820" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="456" y="836" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="456" y="980" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="464" y="612" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="464" y="676" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="464" y="788" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="464" y="804" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="464" y="820" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="464" y="836" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="464" y="932" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="464" y="980" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="472" y="612" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="472" y="676" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="472" y="788" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="472" y="804" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="472" y="820" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="472" y="836" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="472" y="980" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="480" y="612" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="480" y="676" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="480" y="788" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="480" y="804" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="480" y="820" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="480" y="836" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="488" y="612" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="488" y="676" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="488" y="836" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="488" y="980" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="496" y="612" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="496" y="676" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="496" y="836" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="496" y="980" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="504" y="612" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="504" y="676" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="504" y="836" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="504" y="980" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="512" y="612" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="512" y="836" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="512" y="980" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="520" y="612" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="520" y="836" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="528" y="836" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="536" y="836" fill="currentcolor" style="font-size:1em">]</text></g></svg></div><ol><li><p>MiniRacer Python user code instantiates a <code>py_mini_racer.MiniRacer</code> object
which contains a <code>py_mini_racer._Context</code> object.</p></li><li><p>The <code>py_mini_racer._Context</code> Python object instantiates a C++
<code>MiniRacer::Context</code>, passing in a pointer to a generic callback in the
Python-side <code>_CallbackRegistry</code>. The <code>MiniRacer::Context</code> creates a
<code>MiniRacer::CallbackCaller</code> which has a process-scope <code>callback_caller_id</code>
associated with it.</p></li><li><p>MiniRacer Python user code passes Python function <code>my_callback_func</code> into
<code>MiniRacer.wrap_py_function</code>. <code>MiniRacer</code> stores a wrapper of
<code>my_callback_func</code> in its <code>_CallbackRegistry</code>, thus generating a callback ID.</p></li><li><p><code>MiniRacer.wrap_py_function</code> passes this callback ID down to the C++ side of
the house to generate a V8 callback function.</p></li><li><p><code>MiniRacer::JSCallbackMaker</code> creates a <code>v8::Function</code> within the
<code>v8::Isolate</code>, with data attached containing an array of
<code>[callback_id, callback_caller_id]</code>. This data is all
<code>MiniRacer::JSCallbackMaker</code> needs to later find the right Python-side
callback when this function is called. <code>MiniRacer::JSCallbackMaker</code> returns a
handle to this <code>v8::Function</code> all the way back up to Python, which can then
take that handle (represented as a <code>JSFunction</code> in Python) and pass it around
to JavaScript code.</p></li><li><p>Eventually, JavaScript code calls the callback created above.</p></li><li><p>V8 dispatches that callback to <code>MiniRacer::JSCallbackMaker::OnCalledStatic</code>.</p></li><li><p><code>MiniRacer::JSCallbackMaker::OnCalledStatic</code> digs out the
<code>[callback_id, callback_caller_id]</code> array to find the
<code>MiniRacer::CallbackCaller</code>, and the context-specific callback ID to pass
back to it.</p></li><li><p><code>MiniRacer::CallbackCaller</code> converts the returned V8 value to a
<code>MiniRacer::BinaryValue</code>, and calls back to the Python C function pointer
with that and the callback ID.</p></li><li><p>The <code>MiniRacer._ContextRegistry</code> converts the callback ID to the destination
Python function object (<code>my_callback_func</code>), and finally passes the function
parameters back to it.</p></li></ol><h3 id=un-shared_ptr-all-the-things>Un-<code>shared_ptr</code> all the things
<a href=#un-shared_ptr-all-the-things><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><div style=text-align:center><p><img src=/img/all-the-things.jpg alt="All the things meme"></p></div><p>In my last post, I
<a href=https://bpcreech.com/post/mini-racer-v0.11.1/#stdshared_ptr-all-the-things>talked about</a>
&ldquo;regressing to C++ developer phase 1&rdquo;. As of PyMiniRacer <code>v0.11.1</code> we were using
a DAG of <code>std::shared_ptr</code> references to manage lifecycle of a dozen different
classes.</p><p>I discovered <a href=https://github.com/bpcreech/PyMiniRacer/issues/62>a bug</a> that
this logic left behind. The Laissez-faire <code>std::shared_ptr</code> memory management
pattern fails when we have reference cycles, and unfortunately we do have
reference cycles in PyMiniRacer. In particular, we create and throw lambdas onto
the <code>v8::Isolate</code> message loop which contain <code>shared_ptr</code> references to
objects&mldr; which eventually contain <code>shared_ptr</code> references to the <code>v8::Isolate</code>
itself: a reference cycle! (We also had some bare references <em>not</em> managed by a
<code>shared_ptr</code>, which would result in a use-after-free in hard-to-reach situations
during teardown of PyMiniRacer.)</p><p>A sticky point with PyMiniRacer&rsquo;s design is that it uses the <code>v8::Isolate</code>
message queue even for teardown: we put tasks on the message queue which delete
C++ objects, because it&rsquo;s the easiest way to ensure they&rsquo;re deleted under the
<code>v8::Isolate</code> lock (discussion of that
<a href=https://groups.google.com/g/v8-users/c/glG3-3pufCo>here</a>). A different system
might simply halt the message queue when we&rsquo;re shutting down, but PyMiniRacer
can&rsquo;t simply do that, or it will leak C++ objects on exit.</p><p>After playing with this some and failing to get the lifecycles just right or
even understand consistently the effective teardown order of dozens of different
reference-counted objects, I realized we could switch to a different,
easier-to-think-about pattern: every object putting tasks onto the <code>v8::Isolate</code>
simply needs to ensure those tasks complete before it <em>anything it puts into
those tasks</em> is torn down.</p><p>I&rsquo;ll restate that rule: <em>if you call <code>MiniRacer::IsolateManager::Run(xyz)</code>, you
had better ensure that task is done <strong>before</strong> you destruct any objects you
bound into the lambda <code>xyz</code>.</em></p><p>This rule seems obvious in restrospect! But it&rsquo;s hard to implement. I:</p><ol><li><p>Modified <code>MiniRacer::IsolateManager::Run</code> to always return a future, to make
it easier to wait on these tasks</p></li><li><p>Refactored <code>CancelableTaskManager</code> completely to make it <em>explicitly track</em>
all the tasks it makes, just so it can reliably cancel <em>and await</em> them all
upon teardown (where before it was sort of &ldquo;fire and forget&rdquo;).</p></li><li><p>Added a simple new garbage-collection algorithm in <code>IsolateObjectCollector</code>
to ensure all the garbage is gone before we move on to tearing down the
<code>IsolateManager</code> and its message pump loop.</p></li></ol><h3 id=breaking-up-the-python-code>Breaking up the Python code
<a href=#breaking-up-the-python-code><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>As of <code>v0.7.0</code> PyMiniRacer was basically a single file, 519 lines of code.</p><p>As of <code>v0.11.1</code> that file was up to 1,355 lines of code. This was quickly
growing beyond manageability!</p><p>So I split it up. The largest file is now 473 LoC.</p><p>Splitting up code is always an exercise in breaking the code down into component
parts, drawing out a DAG (hopefully acyclic!), and lumping things back together
into files where <em>hopefully</em> a logical pattern emerges.</p><p>A novel part of this, to me, is that when using strict types (which PyMiniRacer
does as of <code>v0.11.1</code>), in order to avoid import cycles after breaking files up,
we need to define
<a href=https://docs.python.org/3/library/abc.html>Abstract Base Classes</a>. E.g., if
type <code>A</code> has methods which depend on type <code>B</code> <em>and vice versa</em>, and you want to
put <code>A</code> and <code>B</code> into separate Python files, <em>and</em> have <code>A</code> and <code>B</code> describe each
other with typing information, the only recourse is to define an abstract
interface for either <code>A</code> or <code>B</code> <em>or both</em>, and put that into a <em>third</em> (and
maybe <em>fourth</em>) Python file.</p><p>This (defining a common interface or abstract type to break up import cycles) is
a really developer journey in C++ and Java, but this was the first time I&rsquo;ve
found myself doing it in Python. Hooray for strict types?</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/javascript/ rel=tag>javascript</a></li><li class=tags__item><a class="tags__link btn" href=/tags/typescript/ rel=tag>typescript</a></li><li class=tags__item><a class="tags__link btn" href=/tags/python/ rel=tag>python</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Ben Creech avatar" src=/img/maine_cropped.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Ben Creech</span></div><div class=authorbox__description>Ben Creech is definitely a real person and insisting on this fact is not at all suspicious.</div></div><section class=comments><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bpcreech.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2024 Ben Creech.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>