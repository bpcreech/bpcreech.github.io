<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>PyMiniRacer v0.12.2 - Disparate Treasures</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="PyMiniRacer v0.12.2"><meta property="og:description" content="The dynamic language embedding
turducken is complete: you can now
call Python from JavaScript from Python!
As of PyMiniRacer v0.12.2, you can
write logic in Python and expose it to V8&rsquo;s JavaScript sandbox. You can now in
theory, while writing only Python and JavaScript, create your own JS extension
library similar to
NodeJS&rsquo;s standard library. Obviously,
anything created this way this will almost certainly be less extensive, less
standardized, and less efficient than the NodeJS standard library; but it will
be more tailored to your needs.
This post follows up on prior content related to
reviving PyMiniRacer and then
giving Python code the power to directly poke JS Objects, call JS Functions, and await JS Promises."><meta property="og:type" content="article"><meta property="og:url" content="https://bpcreech.com/post/mini-racer-v0.12.2/"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-05-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-24T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PyMiniRacer v0.12.2"><meta name=twitter:description content="The dynamic language embedding
turducken is complete: you can now
call Python from JavaScript from Python!
As of PyMiniRacer v0.12.2, you can
write logic in Python and expose it to V8&rsquo;s JavaScript sandbox. You can now in
theory, while writing only Python and JavaScript, create your own JS extension
library similar to
NodeJS&rsquo;s standard library. Obviously,
anything created this way this will almost certainly be less extensive, less
standardized, and less efficient than the NodeJS standard library; but it will
be more tailored to your needs.
This post follows up on prior content related to
reviving PyMiniRacer and then
giving Python code the power to directly poke JS Objects, call JS Functions, and await JS Promises."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title="Disparate Treasures" rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/squirrel.png></div><div class="logo__item logo__text"><div class=logo__title>Disparate Treasures</div><div class=logo__tagline>Ben Creech's arbitrary stuff</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>PyMiniRacer v0.12.2</h1><p class=post__lead>Call your Python from your JavaScript from your Python</p></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#adding-python-extensions-to-v8-without-writing-any-c-code>Adding Python extensions to V8 without writing any C++ code</a><ul><li><a href=#security-note>Security note</a></li><li><a href=#about-async>About <code>async</code></a></li></ul></li><li><a href=#internal-changes-to-pyminiracer>Internal changes to PyMiniRacer</a><ul><li><a href=#implementing-wrap_py_function>Implementing <code>wrap_py_function</code></a></li><li><a href=#making-teardown-more-deterministic>Making teardown more deterministic</a></li></ul></li></ul></nav></div></div><div class="content post__content clearfix"><p>The dynamic language embedding
<a href=https://en.wikipedia.org/wiki/Turducken>turducken</a> is complete: you can now
call Python from JavaScript from Python!</p><p>As of <a href=https://github.com/bpcreech/PyMiniRacer>PyMiniRacer</a> <code>v0.12.2</code>, you can
write logic in Python and expose it to V8&rsquo;s JavaScript sandbox. You can now in
theory, while writing <em>only Python and JavaScript</em>, create your own JS extension
library similar to
<a href=https://nodejs.org/docs/latest/api/>NodeJS&rsquo;s standard library</a>. Obviously,
anything created this way this will almost certainly be less extensive, less
standardized, and less efficient than the NodeJS standard library; but it <em>will</em>
be <em>more tailored to your needs</em>.</p><p>This post follows up on prior content related to
<a href=https://github.com/bpcreech/PyMiniRacer>reviving PyMiniRacer</a> and then
<a href=https://bpcreech.com/post/mini-racer-v0.11.1/>giving Python code the power to directly poke JS Objects, call JS Functions, and await JS Promises</a>.</p><h2 id=adding-python-extensions-to-v8-without-writing-any-c-code>Adding Python extensions to V8 without writing any C++ code
<a href=#adding-python-extensions-to-v8-without-writing-any-c-code><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><p>PyMiniRacer runs a pretty vanilla V8 sandbox, and thus it doesn&rsquo;t have any
<a href=https://developer.mozilla.org/en-US/docs/Web/API>Web APIs</a>,
<a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API>Web Workers APIs</a>,
or any of <a href=https://nodejs.org/docs/latest/api/>the NodeJS SDK</a>. This provides,
by default, both simplicity and
<a href=https://bpcreech.com/PyMiniRacer/architecture/#security-goals>security</a>.</p><p>Thus, until now, you couldn&rsquo;t, say, go and grab a random URL off the Internet,
or even log to stdout (e.g., using <code>console.log</code>). No APIs for either operation
are bundled with V8.</p><p>Well, now you can use PyMiniRacer to extend the JavaScript API, thereby adding
that functionality yourself!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> aiohttp
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> py_mini_racer <span style=color:#f92672>import</span> MiniRacer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mr <span style=color:#f92672>=</span> MiniRacer()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>demo</span>():
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>log</span>(content):
</span></span><span style=display:flex><span>    print(content)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>antigravity</span>():
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> antigravity
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> aiohttp<span style=color:#f92672>.</span>ClientSession() <span style=color:#66d9ef>as</span> session:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_url</span>(url):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> session<span style=color:#f92672>.</span>get(url) <span style=color:#66d9ef>as</span> resp:
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> resp<span style=color:#f92672>.</span>text()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> (
</span></span><span style=display:flex><span>         mr<span style=color:#f92672>.</span>wrap_py_function(log) <span style=color:#66d9ef>as</span> log_js,
</span></span><span style=display:flex><span>         mr<span style=color:#f92672>.</span>wrap_py_function(get_url) <span style=color:#66d9ef>as</span> get_url_js,
</span></span><span style=display:flex><span>         mr<span style=color:#f92672>.</span>wrap_py_function(antigravity) <span style=color:#66d9ef>as</span> antigravity_js,
</span></span><span style=display:flex><span>      ):
</span></span><span style=display:flex><span>      <span style=color:#75715e># Add a basic log-to-stdout capability to JavaScript:</span>
</span></span><span style=display:flex><span>      mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;this&#39;</span>)[<span style=color:#e6db74>&#39;log&#39;</span>] <span style=color:#f92672>=</span> log_js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Add a basic url fetch capability to JavaScript:</span>
</span></span><span style=display:flex><span>      mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;this&#39;</span>)[<span style=color:#e6db74>&#39;get_url&#39;</span>] <span style=color:#f92672>=</span> get_url_js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Add antigravity:</span>
</span></span><span style=display:flex><span>      mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#39;this&#39;</span>)[<span style=color:#e6db74>&#39;antigravity&#39;</span>] <span style=color:#f92672>=</span> antigravity_js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> mr<span style=color:#f92672>.</span>eval(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async () =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   const content = await get_url(&#34;https://xkcd.com/353/&#34;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   await log(content);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   await antigravity();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># prints the contents of https://xkcd.com/353/ to stdout... and then also loads it in</span>
</span></span><span style=display:flex><span><span style=color:#75715e># your browser:</span>
</span></span><span style=display:flex><span>asyncio<span style=color:#f92672>.</span>run(demo())
</span></span></code></pre></div><h3 id=security-note>Security note
<a href=#security-note><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>It is possible (<em>modulo open-source disclaimers of warranty, etc</em>) to use
PyMiniRacer to run untrusted JS code; this is a
<a href=https://bpcreech.com/PyMiniRacer/architecture/#security-goals>stated security goal</a>.</p><p>However, exposing your Python functions to JavaScript of course breaches the
hermetic V8 sandbox. If you extend PyMiniRacer by exposing Python functions, you
are obviously taking security matters into your own hands. The above demo, by
exposing an arbitrary <code>get_url</code> function, would expose an obvious data
exfiltration and denial-of-service vector if we were running untrusted JS code
with it.</p><h3 id=about-async>About <code>async</code>
<a href=#about-async><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>You will note that the above demo is using <code>async</code> heavily, both on the Python
and JavaScript side. PyMiniRacer only lets you expose <code>async</code> Python functions
to V8. These are represented as <code>async</code> on the JavaScript side, meaning you need
to <code>await</code> them, meaning in turn that the easiest way to even call them is from
<code>async</code> JavaScript code. Everything gets
<a href=https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/>red</a>
very fast!</p><p>It turns out this is the only way to reliably expose Python functionality to V8.
V8 runs JavaScript in a single-threaded fashion, and doing anything synchronous
in a callback to Python would block the entire V8 isolate. Worse, things would
likely deadlock very quickly—if your Python extension function tries to call
back into V8 it will freeze. The only thing we can reasonably do, when
JavaScript calls outside the V8 sandbox, is create and return a <code>Promise</code>, and
then do the work actually needed to <em>fulfill</em> that <code>Promise</code> out of band.</p><h2 id=internal-changes-to-pyminiracer>Internal changes to PyMiniRacer
<a href=#internal-changes-to-pyminiracer><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h2><h3 id=implementing-wrap_py_function>Implementing <code>wrap_py_function</code>
<a href=#implementing-wrap_py_function><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><p>I put some general design ideas about <code>wrap_py_function</code>
<a href=https://github.com/bpcreech/PyMiniRacer/issues/39>here</a>. What landed in
PyMiniRacer is basically &ldquo;Alternate implementation idea 3&rdquo;
<a href=https://github.com/bpcreech/PyMiniRacer/issues/39#issuecomment-2043984826>on the GitHub issue outlining this feature</a>.
Generally speaking:</p><h4 id=generalizing-pyminiracer-callbacks-and-sharing-allocated-objects-with-v8>Generalizing PyMiniRacer callbacks and sharing allocated objects with V8
<a href=#generalizing-pyminiracer-callbacks-and-sharing-allocated-objects-with-v8><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h4><p>PyMiniRacer already had a C++-to-Python callback mechanism; this was used to
await <code>Promise</code> objects. We just had to generalize it!</p><p>&mldr; Which specifically means allowing V8 to <em>reuse</em> a callback. With <code>Promises</code>,
callbacks are only used 0.5 times on average (either the <code>resolve</code> or <code>reject</code>
is used, exactly once). PyMiniRacer handled cleanup of these on its own; the
first time either <code>resolve</code> or <code>reject</code> was called, PyMiniRacer could destroy
both callbacks. This technique was borrowed from
<a href=https://github.com/v8/v8/blob/0f719663da59ee690f3b72c520f8f9ea2328071a/src/d8/d8.cc#L1493>V8&rsquo;s d8 tool</a>.</p><p>But now we want to expose arbitary-use callbacks, which need to live longer&mldr;
We just need to attach a tiny bit of C++ state (the Python address of the
callback function, and a pointer to our V8 value wrapper) to a callback object,
and hand that off to V8.</p><p>Unfortunately,
<a href=https://stackoverflow.com/questions/24107280/v8-weakcallback-never-gets-called>V8 is pretty apathetic about telling us when it&rsquo;s <em>done with</em> an external C++ object we give it</a>.
I couldn&rsquo;t make the V8 finalizer callback work at all, and all commentary I can
find on the matter says trying to get V8 <code>MakeWeak</code> and finalizers work reliably
is a fool&rsquo;s errand. This creates a memory management conundrum: we need to
create a small bit of per-callback C++ state and hand it to V8, but V8 won&rsquo;t
reliably tell us when it has finally dropped all references to that state.</p><p>So I moved to a model of creating <em>one such callback object per MiniRacer
context</em>. This object outlives the <code>v8::Isolate</code>, so we&rsquo;re no longer relying on
V8 to tell us when it&rsquo;s done with the pointer we gave it. In order to multiplex
many callbacks through that one object, we can just give JavaScript an ID number
(because V8 <em>does</em> manage to reliably destruct numbers!). This new logic lives
in
<a href=https://github.com/bpcreech/PyMiniRacer/blob/release/v0.12.2/src/v8_py_frontend/js_callback_maker.h><code>MiniRacer::JSCallbackMaker</code></a>.</p><p>Meanwhile the Python side of things can manage its own map of ID number to
callback, and remove entries from that map when it wants to. (This is what the
<code>wrap_py_function</code> context manager does on <code>__exit__</code>). Since Python is tearing
down the callback and its ID on its own schedule, in total ignorance of
JavaScript&rsquo;s references to that same callback ID, it&rsquo;s possible for JS to keep
trying to call the callback after Python already tore it down. This is working
as designed; such calls can be easily spotted when the either
<code>callback_caller_id</code> or <code>callback_id</code> doesn&rsquo;t reference an active
<code>CallbackCaller</code> or callback, respectively (see diagram below). Calls to
invalidated ID numbers can be easily and safely ignored.</p><p>I think this could be turned into a generalized strategy for safely sharing
allocated C++ memory with V8:</p><ol><li>Assume any <em>raw</em> pointers and references to C++ objects which you directly
share with V8 will need to live at least as long as the <code>V8::Isolate</code>.</li><li>If you want to be able to delete any objects <em>before</em> the <code>v8::Isolate</code>
exits, don&rsquo;t share <em>raw</em> pointers and references. Instead:<ol><li>On the C++ side, create an ID-number-to-pointer map, and give V8 only ID
numbers, as the <code>data</code> argument of <code>v8::Function::New</code>.</li><li>Your <code>v8::Function</code> callback implementation can read the ID number and
safely convert it to a C++ pointer by looking it up in the map.</li><li>Design an API, whether in C++ or JavaScript (or Python which calls C++ in
PyMiniRacer&rsquo;s case) which authoratively tears down the C++ object and the
ID-number-to-pointer map entry. (Don&rsquo;t rely on V8 to tell you when all
references to the object have dropped; it won&rsquo;t do this reliably.)</li><li>Because we aren&rsquo;t tracking dangling IDs on the JavaScript side (we
can&rsquo;t!), be prepared for JavaScript code to try and use the ID after
you&rsquo;ve torn down the object. The C++ code can easily detect this (because
the ID is not in the map), and safely reject such attempts.</li></ol></li></ol><h4 id=system-diagram>System diagram
<a href=#system-diagram><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h4><p>Here&rsquo;s roughly what the system looks like:</p><table border=0><tr><td width=50%><div style=min-width:200px><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 536 1177"><g transform="translate(8,16)"><path d="M0 0H328" fill="none" stroke="currentcolor"/><path d="M128 64H312" fill="none" stroke="currentcolor"/><path d="M128 128h88" fill="none" stroke="currentcolor"/><path d="M216 128h96" fill="none" stroke="currentcolor"/><path d="M0 160H136" fill="none" stroke="currentcolor"/><path d="M136 160h72" fill="none" stroke="currentcolor"/><path d="M224 160h32" fill="none" stroke="currentcolor"/><path d="M272 160h56" fill="none" stroke="currentcolor"/><path d="M0 208H208" fill="none" stroke="currentcolor"/><path d="M224 208h32" fill="none" stroke="currentcolor"/><path d="M272 208h56" fill="none" stroke="currentcolor"/><path d="M16 272H208" fill="none" stroke="currentcolor"/><path d="M224 272h32" fill="none" stroke="currentcolor"/><path d="M272 272h40" fill="none" stroke="currentcolor"/><path d="M32 336H264" fill="none" stroke="currentcolor"/><path d="M264 336h32" fill="none" stroke="currentcolor"/><path d="M32 4e2H216" fill="none" stroke="currentcolor"/><path d="M216 4e2h80" fill="none" stroke="currentcolor"/><path d="M16 432H144" fill="none" stroke="currentcolor"/><path d="M144 432h64" fill="none" stroke="currentcolor"/><path d="M224 432h32" fill="none" stroke="currentcolor"/><path d="M272 432h40" fill="none" stroke="currentcolor"/><path d="M0 464H136" fill="none" stroke="currentcolor"/><path d="M152 464h56" fill="none" stroke="currentcolor"/><path d="M224 464h32" fill="none" stroke="currentcolor"/><path d="M272 464h56" fill="none" stroke="currentcolor"/><path d="M0 560H208" fill="none" stroke="currentcolor"/><path d="M224 560h32" fill="none" stroke="currentcolor"/><path d="M272 560h40" fill="none" stroke="currentcolor"/><path d="M16 624H256" fill="none" stroke="currentcolor"/><path d="M272 624h24" fill="none" stroke="currentcolor"/><path d="M344 640H520" fill="none" stroke="currentcolor"/><path d="M32 688H264" fill="none" stroke="currentcolor"/><path d="M264 688h16" fill="none" stroke="currentcolor"/><path d="M288 720h56" fill="none" stroke="currentcolor"/><path d="M32 752H280" fill="none" stroke="currentcolor"/><path d="M344 752H520" fill="none" stroke="currentcolor"/><path d="M16 784H216" fill="none" stroke="currentcolor"/><path d="M216 784h80" fill="none" stroke="currentcolor"/><path d="M312 784H424" fill="none" stroke="currentcolor"/><path d="M440 784h80" fill="none" stroke="currentcolor"/><path d="M16 816H208" fill="none" stroke="currentcolor"/><path d="M224 816H424" fill="none" stroke="currentcolor"/><path d="M440 816h64" fill="none" stroke="currentcolor"/><path d="M240 880H432" fill="none" stroke="currentcolor"/><path d="M432 880h56" fill="none" stroke="currentcolor"/><path d="M216 912h16" fill="none" stroke="currentcolor"/><path d="M256 960H472" fill="none" stroke="currentcolor"/><path d="M32 976H176" fill="none" stroke="currentcolor"/><path d="M176 1008h56" fill="none" stroke="currentcolor"/><path d="M32 1040H176" fill="none" stroke="currentcolor"/><path d="M256 1056H472" fill="none" stroke="currentcolor"/><path d="M240 1088H488" fill="none" stroke="currentcolor"/><path d="M16 1120H504" fill="none" stroke="currentcolor"/><path d="M0 1152H520" fill="none" stroke="currentcolor"/><path d="M0 0V160" fill="none" stroke="currentcolor"/><path d="M0 208V464" fill="none" stroke="currentcolor"/><path d="M0 560v592" fill="none" stroke="currentcolor"/><path d="M16 272V432" fill="none" stroke="currentcolor"/><path d="M16 624V784" fill="none" stroke="currentcolor"/><path d="M16 816v304" fill="none" stroke="currentcolor"/><path d="M32 336v64" fill="none" stroke="currentcolor"/><path d="M32 688v64" fill="none" stroke="currentcolor"/><path d="M32 976v64" fill="none" stroke="currentcolor"/><path d="M128 64v64" fill="none" stroke="currentcolor"/><path d="M136 160v32" fill="none" stroke="currentcolor"/><path d="M144 432V544" fill="none" stroke="currentcolor"/><path d="M176 976v32" fill="none" stroke="currentcolor"/><path d="M176 1008v32" fill="none" stroke="currentcolor"/><path d="M216 128V320" fill="none" stroke="currentcolor"/><path d="M216 4e2V608" fill="none" stroke="currentcolor"/><path d="M216 784V912" fill="none" stroke="currentcolor"/><path d="M240 880v208" fill="none" stroke="currentcolor"/><path d="M256 960v96" fill="none" stroke="currentcolor"/><path d="M264 144V336" fill="none" stroke="currentcolor"/><path d="M264 416V688" fill="none" stroke="currentcolor"/><path d="M280 688v64" fill="none" stroke="currentcolor"/><path d="M296 336v64" fill="none" stroke="currentcolor"/><path d="M296 624v80" fill="none" stroke="currentcolor"/><path d="M296 736v48" fill="none" stroke="currentcolor"/><path d="M312 64v64" fill="none" stroke="currentcolor"/><path d="M312 272V432" fill="none" stroke="currentcolor"/><path d="M312 560V704" fill="none" stroke="currentcolor"/><path d="M312 736v48" fill="none" stroke="currentcolor"/><path d="M328 0V160" fill="none" stroke="currentcolor"/><path d="M328 208V464" fill="none" stroke="currentcolor"/><path d="M344 640v80" fill="none" stroke="currentcolor"/><path d="M344 720v32" fill="none" stroke="currentcolor"/><path d="M432 768V880" fill="none" stroke="currentcolor"/><path d="M472 960v96" fill="none" stroke="currentcolor"/><path d="M488 880v208" fill="none" stroke="currentcolor"/><path d="M504 816v304" fill="none" stroke="currentcolor"/><path d="M520 640V752" fill="none" stroke="currentcolor"/><path d="M520 784v368" fill="none" stroke="currentcolor"/><path d="M296 704v8" fill="none" stroke="currentcolor"/><path d="M296 728v8" fill="none" stroke="currentcolor"/><path d="M312 704v8" fill="none" stroke="currentcolor"/><path d="M312 728v8" fill="none" stroke="currentcolor"/><path d="M136 192v8" fill="none" stroke="currentcolor"/><polygon points="152.000000,192.000000 140.000000,186.399994 140.000000,197.600006" fill="currentcolor" transform="rotate(90.000000, 136.000000, 192.000000)"/><path d="M144 544v8" fill="none" stroke="currentcolor"/><polygon points="160.000000,544.000000 148.000000,538.400024 148.000000,549.599976" fill="currentcolor" transform="rotate(90.000000, 144.000000, 544.000000)"/><path d="M216 320v8" fill="none" stroke="currentcolor"/><polygon points="232.000000,320.000000 220.000000,314.399994 220.000000,325.600006" fill="currentcolor" transform="rotate(90.000000, 216.000000, 320.000000)"/><path d="M216 608v8" fill="none" stroke="currentcolor"/><polygon points="232.000000,608.000000 220.000000,602.400024 220.000000,613.599976" fill="currentcolor" transform="rotate(90.000000, 216.000000, 608.000000)"/><polygon points="240.000000,912.000000 228.000000,906.400024 228.000000,917.599976" fill="currentcolor" transform="rotate(0.000000, 232.000000, 912.000000)"/><polygon points="240.000000,1008.000000 228.000000,1002.400024 228.000000,1013.599976" fill="currentcolor" transform="rotate(0.000000, 232.000000, 1008.000000)"/><path d="M264 136v8" fill="none" stroke="currentcolor"/><polygon points="280.000000,144.000000 268.000000,138.399994 268.000000,149.600006" fill="currentcolor" transform="rotate(270.000000, 264.000000, 144.000000)"/><path d="M264 408v8" fill="none" stroke="currentcolor"/><polygon points="280.000000,416.000000 268.000000,410.399994 268.000000,421.600006" fill="currentcolor" transform="rotate(270.000000, 264.000000, 416.000000)"/><polygon points="296.000000,720.000000 284.000000,714.400024 284.000000,725.599976" fill="currentcolor" transform="rotate(180.000000, 288.000000, 720.000000)"/><path d="M432 760v8" fill="none" stroke="currentcolor"/><polygon points="448.000000,768.000000 436.000000,762.400024 436.000000,773.599976" fill="currentcolor" transform="rotate(270.000000, 432.000000, 768.000000)"/><text text-anchor="middle" x="0" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="8" y="500" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="8" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="8" y="532" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="16" y="500" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="16" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="16" y="532" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="16" y="580" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="24" y="500" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="24" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="24" y="532" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="24" y="580" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="32" y="500" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="32" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="32" y="580" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="32" y="660" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="40" y="500" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="40" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="40" y="532" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="40" y="580" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="40" y="660" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="40" y="852" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="48" y="500" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="48" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="48" y="532" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="48" y="580" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="48" y="660" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="48" y="852" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="48" y="1012" fill="currentcolor" style="font-size:1em">J</text><text text-anchor="middle" x="56" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="56" y="532" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="580" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="660" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="56" y="724" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="56" y="852" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="56" y="1012" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="500" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="64" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="64" y="532" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="64" y="580" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="64" y="660" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="64" y="724" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="64" y="852" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="64" y="1012" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="72" y="500" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="72" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="72" y="532" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="580" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="660" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="72" y="724" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="72" y="852" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="72" y="1012" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="80" y="500" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="80" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="80" y="580" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="80" y="660" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="80" y="724" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="80" y="852" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="80" y="1012" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="88" y="372" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="88" y="500" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="88" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="88" y="580" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="88" y="660" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="88" y="724" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="88" y="852" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="1012" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="96" y="372" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="96" y="500" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="96" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="96" y="580" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="96" y="660" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="96" y="724" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="96" y="852" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="96" y="1012" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="104" y="372" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="104" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="104" y="580" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="104" y="660" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="104" y="724" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="104" y="852" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="104" y="1012" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="112" y="180" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="112" y="372" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="112" y="580" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="660" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="112" y="724" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="112" y="852" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="112" y="1012" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="120" y="372" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="120" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="120" y="580" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="660" fill="currentcolor" style="font-size:1em">J</text><text text-anchor="middle" x="120" y="724" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="120" y="852" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="1012" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="128" y="36" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="128" y="244" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="128" y="308" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="128" y="372" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="128" y="452" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="128" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="128" y="580" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="128" y="660" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="128" y="724" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="136" y="244" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="136" y="308" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="136" y="372" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="136" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="136" y="580" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="660" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="136" y="724" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="136" y="1012" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="144" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="144" y="244" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="144" y="308" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="144" y="372" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="144" y="580" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="144" y="660" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="144" y="724" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="144" y="1012" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="152" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="152" y="244" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="152" y="308" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="152" y="372" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="152" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="152" y="580" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="152" y="660" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="152" y="724" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="152" y="1012" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="160" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="160" y="100" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="160" y="244" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="160" y="308" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="160" y="372" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="160" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="160" y="660" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="160" y="724" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="160" y="1012" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="168" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="168" y="244" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="168" y="308" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="168" y="372" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="168" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="168" y="660" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="168" y="724" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="176" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="176" y="244" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="176" y="308" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="176" y="372" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="176" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="176" y="660" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="176" y="724" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="184" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="184" y="244" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="184" y="308" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="184" y="372" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="184" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="184" y="660" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="184" y="724" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="192" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="192" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="192" y="244" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="192" y="372" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="192" y="660" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="192" y="724" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="200" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="200" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="200" y="148" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="200" y="372" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="200" y="420" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="200" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="200" y="660" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="200" y="724" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="200" y="804" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="200" y="996" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="208" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="208" y="372" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="208" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="208" y="660" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="724" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="216" y="100" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="216" y="372" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="216" y="660" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="216" y="724" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="224" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="224" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="224" y="660" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="224" y="724" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="232" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="232" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="232" y="660" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="232" y="724" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="240" y="100" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="240" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="240" y="724" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="100" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="248" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="248" y="676" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="248" y="724" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="256" y="100" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="256" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="256" y="916" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="256" y="948" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="264" y="100" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="264" y="916" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="264" y="948" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="272" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="272" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="272" y="916" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="272" y="948" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="272" y="1012" fill="currentcolor" style="font-size:1em">[</text><text text-anchor="middle" x="280" y="100" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="280" y="324" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="280" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="280" y="916" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="280" y="948" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="280" y="996" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="280" y="1012" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="280" y="1028" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="288" y="324" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="288" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="288" y="916" fill="currentcolor" style="font-size:1em">F</text><text text-anchor="middle" x="288" y="948" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="288" y="996" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="288" y="1012" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="288" y="1028" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="296" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="296" y="916" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="296" y="996" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="296" y="1012" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="296" y="1028" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="304" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="304" y="916" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="304" y="996" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="304" y="1012" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="304" y="1028" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="312" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="312" y="916" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="312" y="996" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="312" y="1012" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="312" y="1028" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="320" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="320" y="916" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="320" y="996" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="320" y="1012" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="320" y="1028" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="328" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="328" y="740" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="328" y="916" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="328" y="996" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="328" y="1012" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="328" y="1028" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="336" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="336" y="916" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="336" y="996" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="336" y="1012" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="336" y="1028" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="344" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="344" y="916" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="344" y="996" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="344" y="1012" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="344" y="1028" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="352" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="352" y="1012" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="352" y="1028" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="360" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="360" y="692" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="360" y="1012" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="360" y="1028" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="368" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="368" y="692" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="368" y="1012" fill="currentcolor" style="font-size:1em">,</text><text text-anchor="middle" x="368" y="1028" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="376" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="376" y="692" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="376" y="708" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="376" y="724" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="376" y="1028" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="384" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="384" y="692" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="384" y="708" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="384" y="724" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="384" y="1028" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="392" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="392" y="692" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="392" y="708" fill="currentcolor" style="font-size:1em">J</text><text text-anchor="middle" x="392" y="724" fill="currentcolor" style="font-size:1em">O</text><text text-anchor="middle" x="392" y="1028" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="400" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="400" y="676" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="400" y="692" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="400" y="708" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="400" y="724" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="400" y="1028" fill="currentcolor" style="font-size:1em">_</text><text text-anchor="middle" x="408" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="408" y="676" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="408" y="692" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="408" y="708" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="408" y="724" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="408" y="1028" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="416" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="416" y="676" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="416" y="692" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="416" y="708" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="416" y="724" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="416" y="852" fill="currentcolor" style="font-size:1em">7</text><text text-anchor="middle" x="416" y="1028" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="424" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="424" y="676" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="424" y="692" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="424" y="708" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="424" y="724" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="424" y="1028" fill="currentcolor" style="font-size:1em">]</text><text text-anchor="middle" x="432" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="432" y="676" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="432" y="708" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="432" y="724" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="440" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="440" y="708" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="440" y="724" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="448" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="448" y="708" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="448" y="724" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="456" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="456" y="708" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="456" y="724" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="464" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="464" y="708" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="464" y="724" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="472" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="472" y="708" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="472" y="724" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="480" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="480" y="708" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="480" y="724" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="488" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="488" y="708" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="488" y="724" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="496" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="496" y="708" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="496" y="724" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="504" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="504" y="708" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="512" y="516" fill="currentcolor" style="font-size:1em">·</text><text text-anchor="middle" x="520" y="516" fill="currentcolor" style="font-size:1em">·</text></g></svg></div></div></td><td width=50%><ol><li><p>MiniRacer Python user code instantiates a <code>py_mini_racer.MiniRacer</code> object
which contains a <code>py_mini_racer._Context</code> object.</p></li><li><p>The <code>py_mini_racer._Context</code> Python object instantiates a C++
<code>MiniRacer::Context</code>, passing in a pointer to a generic callback in the
Python-side <code>_CallbackRegistry</code>. The <code>MiniRacer::Context</code> creates a
<code>MiniRacer::CallbackCaller</code> which has a process-scope <code>callback_caller_id</code>
associated with it.</p></li><li><p>MiniRacer Python user code passes Python function <code>my_callback_func</code> into
<code>MiniRacer.wrap_py_function</code>. <code>MiniRacer</code> stores a wrapper of
<code>my_callback_func</code> in its <code>_CallbackRegistry</code>, thus generating a
<code>callback_id</code>.</p></li><li><p><code>MiniRacer.wrap_py_function</code> passes this <code>callback_id</code> down to the C++ side
of the house to generate a V8 callback function.</p></li><li><p><code>MiniRacer::JSCallbackMaker</code> creates a <code>v8::Function</code> within the
<code>v8::Isolate</code>, with data attached containing an array of
<code>[callback_id, callback_caller_id]</code>. This data is all
<code>MiniRacer::JSCallbackMaker</code> needs to later find the right Python-side
callback when this function is called. <code>MiniRacer::JSCallbackMaker</code> returns a
handle to this <code>v8::Function</code> all the way back up to Python, which can then
take that handle (represented as a <code>JSFunction</code> in Python) and pass it around
to JavaScript code.</p></li><li><p>Eventually, JavaScript code calls the callback created above.</p></li><li><p>V8 dispatches that callback to <code>MiniRacer::JSCallbackMaker::OnCalledStatic</code>.</p></li><li><p><code>MiniRacer::JSCallbackMaker::OnCalledStatic</code> digs out the
<code>[callback_id, callback_caller_id]</code> array to find the
<code>MiniRacer::CallbackCaller</code>, and the <code>callback_id</code> to pass back to it.</p></li><li><p><code>MiniRacer::CallbackCaller</code> converts the returned V8 value to a
<code>MiniRacer::BinaryValue</code>, and calls back to the Python C function pointer
with that and the <code>callback_id</code>.</p></li><li><p>The <code>MiniRacer._ContextRegistry</code> converts the <code>callback_id</code> to the
destination Python function object (<code>my_callback_func</code>), and finally passes
the function parameters back to it.</p></li></ol></td></tr></table><h3 id=making-teardown-more-deterministic>Making teardown more deterministic
<a href=#making-teardown-more-deterministic><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 000 6h3a3 3 0 002.83-4H9c-.086.0-.17.01-.25.031A2 2 0 017 10.5H4a2 2 0 110-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 00-2.83 4h1.098A2 2 0 019 6.5h3a2 2 0 110 4h-1.535a4.02 4.02.0 01-.82 1H12a3 3 0 100-6H9z"/></svg></a></h3><div style=text-align:center width=250px><p><img src=/img/all-the-things.jpg alt="All the things meme"></p></div><p>In my last post, I
<a href=https://bpcreech.com/post/mini-racer-v0.11.1/#stdshared_ptr-all-the-things>talked about</a>
&ldquo;regressing to C++ developer phase 1&rdquo; by using <code>std::shared_ptr</code> <em>everywhere</em> to
manage object lifecycles. As of PyMiniRacer <code>v0.11.1</code> we were using a DAG of
<code>std::shared_ptr</code> references to manage lifecycle of a dozen different classes.</p><p>I discovered <a href=https://github.com/bpcreech/PyMiniRacer/issues/62>a bug</a> that
this logic left behind. If JavaScript code launched never-ending background
work, (e.g., <code>setTimeout(() => { while (1) {} }, 100)</code>), the C++
<code>MiniRacer::Context</code> and its <code>v8::Isolate</code> wouldn&rsquo;t actually shut down when told
to by Python side.</p><p>The problem with the laissez-faire <code>std::shared_ptr</code>-all-the-things memory
management pattern is that we leak memory when we have reference cycles.
Unfortunately we <em>do</em> have reference cycles in PyMiniRacer. In particular, all
over PyMiniRacer&rsquo;s C++ codebase, we create and throw function closures onto the
<code>v8::Isolate</code> message queue which contain <code>shared_ptr</code> references to objects&mldr;
which transitively contain <code>shared_ptr</code> references to the <code>v8::Isolate</code>
itself&mldr; which contains references to everything in the message queue: a
reference cycle!</p><p>A simple way to resolve that in <em>another</em> system might be to explicitly clear
out the <code>v8::Isolate</code>&rsquo;s message queue on shutdown. Basically, by wiping out all
the not-yet-executed closures, we can &ldquo;cut&rdquo; all the reference cycles on exit.
However, a sticky point with PyMiniRacer&rsquo;s design is that it uses that same
message queue even for teardown: we put tasks on the message queue which delete
C++ objects, because it&rsquo;s the easiest way to ensure they&rsquo;re deleted under the
<code>v8::Isolate</code> lock (discussion of that
<a href=https://groups.google.com/g/v8-users/c/glG3-3pufCo>here</a>). So PyMiniRacer
can&rsquo;t simply clear out the message queue, or it will leak C++ objects on exit.</p><p>After playing with this some and failing to get the lifecycles just right, and
struggling to even understand the effective teardown order of dozens of
different reference-counted objects, I realized we could switch to a different,
easier-to-think-about pattern: every object putting tasks onto the <code>v8::Isolate</code>
simply needs to ensure those tasks complete before <em>anything it puts into those
tasks</em> is torn down.</p><p>I&rsquo;ll restate that rule: <em>if you call <code>MiniRacer::IsolateManager::Run(xyz)</code>, you
are reponsible for ensuring that task is done <strong>before</strong> any objects you bound
into the function closure <code>xyz</code> are destroyed.</em></p><p>This rule seems obvious in restrospect! But it&rsquo;s hard to implement. I:</p><ol><li><p>Modified
<a href=https://github.com/bpcreech/PyMiniRacer/blob/99591c962b219251d309e0f5899b3cf2a676ab9e/src/v8_py_frontend/isolate_manager.h#L87><code>MiniRacer::IsolateManager::Run</code></a>
to always return a future, to make it easier to wait on these tasks. This is
used
<a href=https://github.com/bpcreech/PyMiniRacer/blob/99591c962b219251d309e0f5899b3cf2a676ab9e/src/v8_py_frontend/isolate_memory_monitor.cc#L49>in</a>
<a href=https://github.com/bpcreech/PyMiniRacer/blob/99591c962b219251d309e0f5899b3cf2a676ab9e/src/v8_py_frontend/context_holder.cc#L28>various</a>
<a href=https://github.com/bpcreech/PyMiniRacer/blob/99591c962b219251d309e0f5899b3cf2a676ab9e/src/v8_py_frontend/context.cc#L51>places</a>
to ensure the above rule is honored.</p></li><li><p>Refactored <code>CancelableTaskManager</code> completely to make it <em>explicitly track</em>
all the tasks it makes, just so it can
<a href=https://github.com/bpcreech/PyMiniRacer/blob/99591c962b219251d309e0f5899b3cf2a676ab9e/src/v8_py_frontend/cancelable_task_runner.cc#L26>reliably cancel <em>and await</em> them all upon teardown</a>
(where before it would just sort of &ldquo;fire and forget&rdquo; tasks, not at all
caring if they ever actually finished).</p></li><li><p>Added a simple new garbage-collection algorithm in
<a href=https://github.com/bpcreech/PyMiniRacer/blob/99591c962b219251d309e0f5899b3cf2a676ab9e/src/v8_py_frontend/isolate_object_collector.h#L13><code>IsolateObjectCollector</code></a>
to ensure all the garbage is gone before we move on to tearing down the
<code>IsolateManager</code> and its message pump loop.</p></li></ol><p>This is a little more code than we had before, but things are much simpler to
reason about now!</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/javascript/ rel=tag>javascript</a></li><li class=tags__item><a class="tags__link btn" href=/tags/typescript/ rel=tag>typescript</a></li><li class=tags__item><a class="tags__link btn" href=/tags/python/ rel=tag>python</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Ben Creech avatar" src=/img/maine_cropped.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Ben Creech</span></div><div class=authorbox__description>Ben Creech is definitely a real person and insisting on this fact is not at all suspicious.</div></div><section class=comments><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bpcreech.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2024 Ben Creech.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>